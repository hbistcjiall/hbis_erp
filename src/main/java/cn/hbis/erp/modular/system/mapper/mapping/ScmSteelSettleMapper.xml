<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.hbis.erp.modular.system.mapper.ScmSteelSettleMapper">
    <select id="getcx" resultType="map">
        select * from      (select
        COMPANYNAME, NAME,  (NVL(ZYFKIMG,0)+ NVL(FGSFKIMG,0)+ NVL(ZGSFKIMG,0)) FKIMG, PZGL , ZYFKIMG, ZYPZGL,  FGSFKIMG,  FGSPZGL, ZGSFKIMG,  ZGSPZGL, SYPZB, HB,  BZ,'1' SX,  ZYBZ, FGSBZ,ZGSBZ ZGSBZ
        from (SELECT
        COMPANYNAME,
        NAME,
        sum(case when fkdat  &gt;= to_date (#{startTime},'yyyy-mm-dd hh24:mi:ss') and fkdat  &lt;= to_date (#{endTime},'yyyy-mm-dd hh24:mi:ss') and product_grade = '品种钢' OR product_grade = '高端产品' OR product_grade = '特色战略产品' then fkimg end)pzgl,
        sum(case when fkdat  &gt;= to_date (#{startTime},'yyyy-mm-dd hh24:mi:ss') and fkdat  &lt;= to_date (#{endTime},'yyyy-mm-dd hh24:mi:ss') and sale_body = '专业公司' then fkimg end)zyfkimg,

        sum(case when fkdat  &gt;= to_date (#{startTime},'yyyy-mm-dd hh24:mi:ss') and fkdat &lt;= to_date (#{endTime},'yyyy-mm-dd hh24:mi:ss') and sale_body = '专业公司' and (product_grade = '品种钢' OR product_grade = '高端产品' OR product_grade = '特色战略产品') then fkimg end)zypzgl,

        sum(case when fkdat  &gt;= to_date (#{startTime},'yyyy-mm-dd hh24:mi:ss') and fkdat  &lt;= to_date (#{endTime},'yyyy-mm-dd hh24:mi:ss') and sale_body = '分公司' then fkimg end)fgsfkimg,

        sum(case when fkdat  &gt;= to_date (#{startTime},'yyyy-mm-dd hh24:mi:ss') and fkdat  &lt;= to_date (#{endTime},'yyyy-mm-dd hh24:mi:ss') and sale_body = '分公司' and (product_grade = '品种钢' OR product_grade = '高端产品' OR product_grade = '特色战略产品') then fkimg end) fgspzgl,

        sum(case when fkdat  &gt;= to_date (#{startTime},'yyyy-mm-dd hh24:mi:ss') and fkdat  &lt;= to_date (#{endTime},'yyyy-mm-dd hh24:mi:ss') and (sale_body  &lt; &gt; '专业公司' or sale_body  &lt; &gt; '分公司' or sale_body is not null)  then fkimg end) zgsfkimg,
        sum(case when fkdat  &gt;= to_date (#{startTime},'yyyy-mm-dd hh24:mi:ss') and fkdat  &lt;= to_date (#{endTime},'yyyy-mm-dd hh24:mi:ss') and (sale_body  &lt; &gt; '专业公司' or sale_body  &lt; &gt; '分公司' or sale_body is not null) and (product_grade = '品种钢' OR product_grade = '高端产品' OR product_grade = '特色战略产品') then fkimg end) zgspzgl,

        sum(case when fkdat  &gt;= to_date (#{startTime},'yyyy-mm-dd hh24:mi:ss') and fkdat  &lt;= to_date (#{endTime},'yyyy-mm-dd hh24:mi:ss') and sale_body = '专业公司' and (product_grade = '品种钢' OR product_grade = '高端产品' OR product_grade = '特色战略产品') then fkimg end)/
        sum(case when fkdat  &gt;= to_date (#{startTime},'yyyy-mm-dd hh24:mi:ss') and fkdat  &lt;= to_date (#{endTime},'yyyy-mm-dd hh24:mi:ss') and sale_body = '专业公司' then fkimg end)zybz,
        sum(case when fkdat  &gt;= to_date (#{startTime},'yyyy-mm-dd hh24:mi:ss') and fkdat  &lt;= to_date (#{endTime},'yyyy-mm-dd hh24:mi:ss') and sale_body = '分公司' and (product_grade = '品种钢' OR product_grade = '高端产品' OR product_grade = '特色战略产品') then fkimg end)/
        sum(case when fkdat  &gt;= to_date (#{startTime},'yyyy-mm-dd hh24:mi:ss') and fkdat  &lt;= to_date (#{endTime},'yyyy-mm-dd hh24:mi:ss') and sale_body = '分公司' then fkimg end)fgsbz,
        sum(case when fkdat  &gt;= to_date (#{startTime},'yyyy-mm-dd hh24:mi:ss') and fkdat  &lt;= to_date (#{endTime},'yyyy-mm-dd hh24:mi:ss') and (sale_body  &lt; &gt; '专业公司' or sale_body  &lt; &gt; '分公司' or sale_body is not null) and (product_grade = '品种钢' OR product_grade = '高端产品' OR product_grade = '特色战略产品') then fkimg end)/
        sum(case when fkdat  &gt;= to_date (#{startTime},'yyyy-mm-dd hh24:mi:ss') and fkdat  &lt;= to_date (#{endTime},'yyyy-mm-dd hh24:mi:ss')  then fkimg end)zgsbz,
        sum(case when fkdat  &gt;= to_date (#{startTime},'yyyy-mm-dd hh24:mi:ss') and fkdat  &lt; = to_date (#{endTime},'yyyy-mm-dd hh24:mi:ss') and product_grade = '品种钢' OR product_grade = '高端产品' OR product_grade = '特色战略产品' then fkimg end)/
        sum(case when fkdat  &gt;= to_date (#{startTime},'yyyy-mm-dd hh24:mi:ss') and fkdat  &lt;= to_date (#{endTime},'yyyy-mm-dd hh24:mi:ss')then fkimg end) bz,
        sum(case when fkdat  &gt;= to_date (#{startTime},'yyyy-mm-dd hh24:mi:ss') and fkdat  &lt;= to_date (#{endTime},'yyyy-mm-dd hh24:mi:ss') and product_grade = '品种钢' OR product_grade = '高端产品' OR product_grade = '特色战略产品' then fkimg end)/
        sum(case when fkdat  &gt;= to_date ('2019-02-01 00:00:00','yyyy-mm-dd hh24:mi:ss') and fkdat  &lt; = to_date ('2019-02-28 00:00:00','yyyy-mm-dd hh24:mi:ss')then fkimg end) sypzb,
        (sum(case when fkdat  &gt; = to_date (#{startTime},'yyyy-mm-dd hh24:mi:ss') and fkdat  &lt;= to_date (#{endTime},'yyyy-mm-dd hh24:mi:ss') and product_grade = '品种钢' OR product_grade = '高端产品' OR product_grade = '特色战略产品' then fkimg end)/
        sum(case when fkdat  &gt;= to_date (#{startTime},'yyyy-mm-dd hh24:mi:ss') and fkdat  &lt;= to_date (#{endTime},'yyyy-mm-dd hh24:mi:ss')then fkimg end))-(sum(case when fkdat  &gt;= to_date ('2019-02-01','yyyy-mm-dd hh24:mi:ss') and fkdat  &lt;= to_date ('2019-02-28','yyyy-mm-dd hh24:mi:ss') and product_grade = '品种钢' OR product_grade = '高端产品' OR product_grade = '特色战略产品' then fkimg end)/
        sum(case when fkdat  &gt;= to_date ('2019-02-01','yyyy-mm-dd hh24:mi:ss') and fkdat  &lt;= to_date ('2019-02-28','yyyy-mm-dd hh24:mi:ss')then fkimg end))hb
        from (SELECT
        distinct decode(settle.company_id,
        9580,
        '唐钢',
        9727,
        '邯钢',
        9193,
        '宣钢',
        9196,
        '承钢',
        1932,
        '舞钢',
        8110,
        '石钢',
        8493,
        '衡板',
        7778,
        '邯宝') AS companyname,
        settle.company_id,
        xsztdzb.sale_body,
        rpcl.product_grade,
        settle.fkimg,
        settle.id,
        settle.fkdat,
        sso.order_mount,
        sso.order_type_describe,
        sso.saler_name,
        sso.sale_group,
        (select max(DATA.Name)
        from scm_delivery_detail detail
        JOIN crm_resource_data DATA
        ON DATA.full_name = detail.ext
        AND DATA.company_id = detail.company_id
        AND (DATA.TYPE = 3 )

        where settle.company_id = detail.company_id
        and settle.vgbel = detail.deliv_numb
        and settle.vgpos = detail.deliv_item
        and ( detail.delivery_delete  &lt; &gt; 'X' or
        detail.delivery_delete is null)) name,
        (select max(detail.ext)
        from scm_delivery_detail detail

        where settle.company_id = detail.company_id
        and settle.vgbel = detail.deliv_numb
        and settle.vgpos = detail.deliv_item
        and ( detail.delivery_delete  &lt; &gt; 'X'  or
        detail.delivery_delete is null))product_line
        FROM scm_steel_settle settle
        left join scm_sale_order sso
        on settle.company_id = sso.company_id
        and settle.aubel = sso.order_no
        and settle.aupos = sso.order_row
        left join (select a.* from price_salebody_relation a where a.is_delete = 0 ) xsztdzb
        ON sso.company_id = xsztdzb.company_id
        AND sso.sale_body = xsztdzb.sale_body_des
        inner join scm_variety_to_pt_gp svtp
        on sso.company_id = svtp.company_id
        and sso.product_code = svtp.product_group

        left join (SELECT a.company_id,
        a.product_class,
        a.product_line_class,
        a.product_class_crude,
        a.product_class_fine,
        a.product_grade
        FROM REPORT_PRODUCT_CLASS_LEVEL a
        where a.status = '0'
        union all
        SELECT b.company_id,
        b.second_code,
        b.product_line_class,
        b.product_class_crude,
        b.product_class_fine,
        b.product_grade
        FROM REPORT_PRODUCT_CLASS_LEVEL b
        where b.status = '0') rpcl
        on sso.company_id = rpcl.company_id
        and sso.product_type = rpcl.product_class
        where
        settle.fkdat &gt;= to_date(#{startTime}, 'yyyy-mm-dd hh24:mi:ss')
        and settle.fkdat &lt;= to_date(#{endTime}, 'yyyy-mm-dd hh24:mi:ss')
        AND ( xsztdzb.sale_body_des  &lt; &gt;'唐钢中厚板公司'  or
        xsztdzb.sale_body_des  &lt; &gt;'唐钢不锈钢公司' or
        xsztdzb.sale_body_des ='出口'  or
        xsztdzb.sale_body_des ='唐银联营公司数据' )
        and  settle.company_id in ('9580','9727','9193','9196')
        order by settle.id desc) t
        where t.order_type_describe not in
        (select distinct cfd.data_name
        from crm_filter_data cfd
        where cfd.data_type = '2'
        and cfd.status = '0'
        and cfd.company_id = t.company_id)
        and t.saler_name not in
        (select cfd.data_name
        from crm_filter_data cfd
        where cfd.data_type = '1'
        and cfd.status = '0'
        and cfd.company_id = t.company_id
        and instr(concat(t.product_line, t.company_id),
        concat(cfd.product_line, cfd.company_id))  &gt; 0)
        AND t.sale_group NOT IN (SELECT cfd.data_name
        FROM crm_filter_data cfd
        WHERE cfd.company_id = t.company_id
        AND cfd.data_type = 9
        AND cfd.status = 0)



        and t.name is not null group by  t.companyname,t.name) a

        union all


        ( select companyname,name,nvl(zyfkimg,0)+ nvl(fgsfkimg,0) +nvl(zgsfkimg,0) fkimg,nvl(zypzgl,0)+nvl(fgspzgl,0)+nvl(zgspzgl,0) pzgl,
        zyfkimg,zypzgl,fgsfkimg,fgspzgl,zgsfkimg,zgspzgl,sypzb,hb,
        (nvl(zypzgl,0)+nvl(fgspzgl,0)+nvl(zgspzgl,0))/(nvl(zyfkimg,0)+ nvl(fgsfkimg,0) +nvl(zgsfkimg,0)) bz,'2'sx,
        (zypzgl/zyfkimg) zypzgl,
        (fgspzgl/fgsfkimg) fgsbz,
        (zgspzgl/zgsfkimg) zgsbz
        from(select  companyname,name,



        sum(case when fkdat  &gt;= to_date (#{startTime},'yyyy-mm-dd hh24:mi:ss') and fkdat  &lt;= to_date (#{endTime},'yyyy-mm-dd hh24:mi:ss') and sale_group = '销售部' then case when fkimg is null then 0 else fkimg end end)

        zyfkimg,

        sum(case when fkdat  &gt;= to_date (#{startTime},'yyyy-mm-dd hh24:mi:ss') and fkdat &lt;= to_date (#{endTime},'yyyy-mm-dd hh24:mi:ss') and sale_group = '销售部' and (product_grade = '品种钢' OR product_grade = '高端产品' OR product_grade = '特色战略产品') then fkimg end)
        zypzgl,
        sum( case when company_id='8110' then
        case when fkdat  &gt;= to_date (#{startTime},'yyyy-mm-dd hh24:mi:ss') and fkdat  &lt;= to_date (#{endTime},'yyyy-mm-dd hh24:mi:ss') and (sggl = '分公司'  or sale_body &lt; &gt; '出口')  then fkimg end else null end )
        fgsfkimg,
        sum( case when company_id='8110' then
        case when fkdat  &gt;= to_date (#{startTime},'yyyy-mm-dd hh24:mi:ss') and fkdat  &lt;= to_date (#{endTime},'yyyy-mm-dd hh24:mi:ss') and (sggl = '分公司'  or sale_body &lt; &gt; '出口') and (product_grade = '品种钢' OR product_grade = '高端产品' OR product_grade = '特色战略产品') then fkimg end else null end )
        fgspzgl,


        sum(case when company_id = '1932'  then
        case when fkdat  &gt;= to_date (#{startTime},'yyyy-mm-dd hh24:mi:ss') and fkdat  &lt;= to_date (#{endTime},'yyyy-mm-dd hh24:mi:ss') and (sale_group = '科技部')  then fkimg end
        when company_id ='8493'  then
        case when fkdat  &gt;= to_date (#{startTime},'yyyy-mm-dd hh24:mi:ss') and fkdat  &lt;= to_date (#{endTime},'yyyy-mm-dd hh24:mi:ss') and (sale_group = '营销中心' or sale_group ='1000' )  then fkimg end end)
        zgsfkimg,
        sum(case when company_id = '1932'  then
        case when fkdat  &gt;= to_date (#{startTime},'yyyy-mm-dd hh24:mi:ss') and fkdat  &lt;= to_date (#{endTime},'yyyy-mm-dd hh24:mi:ss') and (sale_group = '科技部') and (product_grade = '品种钢' OR product_grade = '高端产品' OR product_grade = '特色战略产品') then fkimg end
        when company_id ='8493'  then
        case when fkdat  &gt;= to_date (#{startTime},'yyyy-mm-dd hh24:mi:ss') and fkdat  &lt;= to_date (#{endTime},'yyyy-mm-dd hh24:mi:ss') and (sale_group = '营销中心' or sale_group ='1000' ) and (product_grade = '品种钢' OR product_grade = '高端产品' OR product_grade = '特色战略产品') then fkimg end  end )
        zgspzgl,



        sum(case when fkdat  &gt;= to_date (#{startTime},'yyyy-mm-dd hh24:mi:ss') and fkdat  &lt;= to_date (#{endTime},'yyyy-mm-dd hh24:mi:ss') and product_grade = '品种钢' OR product_grade = '高端产品' OR product_grade = '特色战略产品' then fkimg end)/
        sum(case when fkdat  &gt;= to_date ('2019-02-01 00:00:00','yyyy-mm-dd hh24:mi:ss') and fkdat  &lt; = to_date ('2019-02-28 00:00:00','yyyy-mm-dd hh24:mi:ss')then fkimg end)
        sypzb,

        (sum(case when fkdat  &gt; = to_date (#{startTime},'yyyy-mm-dd hh24:mi:ss') and fkdat  &lt;= to_date (#{endTime},'yyyy-mm-dd hh24:mi:ss') and product_grade = '品种钢' OR product_grade = '高端产品' OR product_grade = '特色战略产品' then fkimg end)/
        sum(case when fkdat  &gt;= to_date (#{startTime},'yyyy-mm-dd hh24:mi:ss') and fkdat  &lt;= to_date (#{endTime},'yyyy-mm-dd hh24:mi:ss')then fkimg end))-(sum(case when fkdat  &gt;= to_date ('2019-02-01','yyyy-mm-dd hh24:mi:ss') and fkdat  &lt;= to_date ('2019-02-28','yyyy-mm-dd hh24:mi:ss') and product_grade = '品种钢' OR product_grade = '高端产品' OR product_grade = '特色战略产品' then fkimg end)/
        sum(case when fkdat  &gt;= to_date ('2019-02-01','yyyy-mm-dd hh24:mi:ss') and fkdat  &lt;= to_date ('2019-02-28','yyyy-mm-dd hh24:mi:ss')then fkimg end))
        hb

        from (SELECT
        distinct decode(settle.company_id,
        9580,
        '唐钢',
        9727,
        '邯钢',
        9193,
        '宣钢',
        9196,
        '承钢',
        1932,
        '舞钢',
        8110,
        '石钢',
        8493,
        '衡板',
        7778,
        '邯宝') AS companyname,
        settle.company_id,
        xsztdzb.sale_body,
        sso.sale_body sggl,
        rpcl.product_grade,
        settle.fkimg,
        settle.id,
        settle.fkdat,
        sso.order_mount,
        sso.order_type_describe,
        sso.saler_name,
        sso.sale_group,
        '' name,
        (select max(detail.ext)
        from scm_delivery_detail detail

        where settle.company_id = detail.company_id
        and settle.vgbel = detail.deliv_numb
        and settle.vgpos = detail.deliv_item
        and ( detail.delivery_delete  &lt; &gt; 'X'  or
        detail.delivery_delete is null))product_line
        FROM scm_steel_settle settle
        left join scm_sale_order sso
        on settle.company_id = sso.company_id
        and settle.aubel = sso.order_no
        and settle.aupos = sso.order_row
        left join (select a.* from price_salebody_relation a where a.is_delete = 0 ) xsztdzb
        ON sso.company_id = xsztdzb.company_id
        AND sso.sale_body = xsztdzb.sale_body_des
        inner join scm_variety_to_pt_gp svtp
        on sso.company_id = svtp.company_id
        and sso.product_code = svtp.product_group

        left join (SELECT a.company_id,
        a.product_class,
        a.product_line_class,
        a.product_class_crude,
        a.product_class_fine,
        a.product_grade
        FROM REPORT_PRODUCT_CLASS_LEVEL a
        where a.status = '0'
        union all
        SELECT b.company_id,
        b.second_code,
        b.product_line_class,
        b.product_class_crude,
        b.product_class_fine,
        b.product_grade
        FROM REPORT_PRODUCT_CLASS_LEVEL b
        where b.status = '0') rpcl
        on sso.company_id = rpcl.company_id
        and sso.product_type = rpcl.product_class
        where
        settle.fkdat &gt;= to_date(#{startTime}, 'yyyy-mm-dd hh24:mi:ss')
        and settle.fkdat &lt;= to_date(#{endTime}, 'yyyy-mm-dd hh24:mi:ss')
        and  settle.company_id in ('8110','8493','1932')

        order by settle.id desc) t
        where t.order_type_describe not in
        (select distinct cfd.data_name
        from crm_filter_data cfd
        where cfd.data_type = '2'
        and cfd.status = '0'
        and cfd.company_id = t.company_id)
        and t.saler_name not in
        (select cfd.data_name
        from crm_filter_data cfd
        where cfd.data_type = '1'
        and cfd.status = '0'
        and cfd.company_id = t.company_id
        and instr(concat(t.product_line, t.company_id),
        concat(cfd.product_line, cfd.company_id))  &gt; 0)
        AND t.sale_group NOT IN (SELECT cfd.data_name
        FROM crm_filter_data cfd
        WHERE cfd.company_id = t.company_id
        AND cfd.data_type = 9
        AND cfd.status = 0)
        group by  t.companyname,t.name  )
        ) ) where 1=1
        <if test="dw != null">
            and COMPANYNAME = #{dw}
        </if>
        <if test="cx != null">
            and   NAME=#{cx}
        </if>
        order by sx,COMPANYNAME, NAME
    </select>


    <select id="getpz" resultType="map">
        select name,
        sum(case when fkdat &gt;= to_date (#{startTime},'yyyy-mm-dd hh24:mi:ss') and fkdat &lt;= to_date (#{endTime},'yyyy-mm-dd hh24:mi:ss') then fkimg end) fkimg,
        sum(case when fkdat &gt;= to_date (#{startTime},'yyyy-mm-dd hh24:mi:ss') and fkdat &lt;= to_date (#{endTime},'yyyy-mm-dd hh24:mi:ss') and product_grade = '品种钢' OR product_grade = '高端产品' OR product_grade = '特色战略产品' then fkimg end)pzgl,
        sum(case when fkdat &gt;= to_date (#{startTime},'yyyy-mm-dd hh24:mi:ss') and fkdat &lt;= to_date (#{endTime},'yyyy-mm-dd hh24:mi:ss') and sale_body = '专业公司' then fkimg end)zyfkimg,
        sum(case when fkdat &gt;= to_date (#{startTime},'yyyy-mm-dd hh24:mi:ss') and fkdat&lt;= to_date (#{endTime},'yyyy-mm-dd hh24:mi:ss') and sale_body = '专业公司' and (product_grade = '品种钢' OR product_grade = '高端产品' OR product_grade = '特色战略产品') then fkimg end)zypzgl,
        sum(case when fkdat &gt;= to_date (#{startTime},'yyyy-mm-dd hh24:mi:ss') and fkdat &lt;= to_date (#{endTime},'yyyy-mm-dd hh24:mi:ss') and sale_body = '分公司' then fkimg end)fgsfkimg,
        sum(case when fkdat &gt;= to_date (#{startTime},'yyyy-mm-dd hh24:mi:ss') and fkdat &lt;= to_date (#{endTime},'yyyy-mm-dd hh24:mi:ss') and sale_body = '分公司' and (product_grade = '品种钢' OR product_grade = '高端产品' OR product_grade = '特色战略产品') then fkimg end) fgsfkimg,
        sum(case when fkdat &gt;= to_date (#{startTime},'yyyy-mm-dd hh24:mi:ss') and fkdat &lt;= to_date (#{endTime},'yyyy-mm-dd hh24:mi:ss') and sale_body = '子公司' then fkimg end)zgsfkimg,
        sum(case when fkdat &gt;= to_date (#{startTime},'yyyy-mm-dd hh24:mi:ss') and fkdat &lt;= to_date (#{endTime},'yyyy-mm-dd hh24:mi:ss') and sale_body = '子公司' and (product_grade = '品种钢' OR product_grade = '高端产品' OR product_grade = '特色战略产品') then fkimg end) zgspzgl,
        sum(case when fkdat &gt;= to_date (#{startTime},'yyyy-mm-dd hh24:mi:ss') and fkdat &lt;= to_date (#{endTime},'yyyy-mm-dd hh24:mi:ss') and sale_body = '专业公司' and (product_grade = '品种钢' OR product_grade = '高端产品' OR product_grade = '特色战略产品') then fkimg end)/
        sum(case when fkdat &gt;= to_date (#{startTime},'yyyy-mm-dd hh24:mi:ss') and fkdat &lt;= to_date (#{endTime},'yyyy-mm-dd hh24:mi:ss') and sale_body = '专业公司' then fkimg end)zybz,
        sum(case when fkdat &gt;= to_date (#{startTime},'yyyy-mm-dd hh24:mi:ss') and fkdat &lt;= to_date (#{endTime},'yyyy-mm-dd hh24:mi:ss') and sale_body = '分公司' and (product_grade = '品种钢' OR product_grade = '高端产品' OR product_grade = '特色战略产品') then fkimg end)/
        sum(case when fkdat &gt;= to_date (#{startTime},'yyyy-mm-dd hh24:mi:ss') and fkdat &lt;= to_date (#{endTime},'yyyy-mm-dd hh24:mi:ss') and sale_body = '分公司' then fkimg end)fgsbz,
        sum(case when fkdat &gt;= to_date (#{startTime},'yyyy-mm-dd hh24:mi:ss') and fkdat &lt;= to_date (#{endTime},'yyyy-mm-dd hh24:mi:ss') and sale_body = '子公司' and (product_grade = '品种钢' OR product_grade = '高端产品' OR product_grade = '特色战略产品') then fkimg end)/
        sum(case when fkdat &gt;= to_date (#{startTime},'yyyy-mm-dd hh24:mi:ss') and fkdat &lt;= to_date (#{endTime},'yyyy-mm-dd hh24:mi:ss') and sale_body = '子公司' then fkimg end)zgsbz,
        sum(case when fkdat &gt;= to_date (#{startTime},'yyyy-mm-dd hh24:mi:ss') and fkdat &lt; = to_date (#{endTime},'yyyy-mm-dd hh24:mi:ss') and product_grade = '品种钢' OR product_grade = '高端产品' OR product_grade = '特色战略产品' then fkimg end)/
        sum(case when fkdat &gt;= to_date (#{startTime},'yyyy-mm-dd hh24:mi:ss') and fkdat &lt;= to_date (#{endTime},'yyyy-mm-dd hh24:mi:ss')then fkimg end) bz,

        sum(case when fkdat &gt;= to_date (#{startagainTime},'yyyy-mm-dd hh24:mi:ss') and fkdat &lt;= to_date (#{endagainTime},'yyyy-mm-dd hh24:mi:ss') and product_grade = '品种钢' OR product_grade = '高端产品' OR product_grade = '特色战略产品' then fkimg end)/
        sum(case when fkdat &gt;= to_date (#{startTime},'yyyy-mm-dd hh24:mi:ss') and fkdat &lt; = to_date (#{endTime},'yyyy-mm-dd hh24:mi:ss')then fkimg end) sypzb,

        (sum(case when fkdat &gt; = to_date (#{startagainTime},'yyyy-mm-dd hh24:mi:ss') and fkdat &lt;= to_date (#{endagainTime},'yyyy-mm-dd hh24:mi:ss') and product_grade = '品种钢' OR product_grade = '高端产品' OR product_grade = '特色战略产品' then fkimg end)/
        sum(case when fkdat &gt;= to_date (#{startTime},'yyyy-mm-dd hh24:mi:ss') and fkdat &lt;= to_date (#{endTime},'yyyy-mm-dd hh24:mi:ss')then fkimg end))-(sum(case when fkdat &gt;= to_date (#{startTime},'yyyy-mm-dd hh24:mi:ss') and fkdat &lt;= to_date (#{endTime},'yyyy-mm-dd hh24:mi:ss') and product_grade = '品种钢' OR product_grade = '高端产品' OR product_grade = '特色战略产品' then fkimg end)/
        sum(case when fkdat &gt;= to_date (#{startTime},'yyyy-mm-dd hh24:mi:ss') and fkdat &lt;= to_date (#{endTime},'yyyy-mm-dd hh24:mi:ss')then fkimg end))hb
        from (SELECT
        distinct
        settle.company_id,
        xsztdzb.sale_body,
        rpcl.product_grade,
        settle.fkimg,
        settle.id,
        settle.fkdat,
        sso.order_mount,
        sso.order_type_describe,
        sso.saler_name,
        sso.sale_group,
        (select max(B.VARIETY)
        from scm_sale_order sso
        JOIN scm_variety_to_pt_gp B
        ON sso.product_code = B.product_group
        and sso.company_id = B.company_id
        where sso.order_no = settle.aubel
        and sso.ORDER_ROW = settle.AUPOS
        AND sso.company_id = settle.company_id
        ) name,
        (select max(detail.ext)
        from scm_delivery_detail detail
        where settle.company_id = detail.company_id
        and settle.vgbel = detail.deliv_numb
        and settle.vgpos = detail.deliv_item
        and ( <![CDATA[ detail.delivery_delete <> 'X' ]]>  or
        detail.delivery_delete is null)) product_line
        FROM scm_steel_settle settle
        left join scm_sale_order sso
        on settle.company_id = sso.company_id
        and settle.aubel = sso.order_no
        and settle.aupos = sso.order_row
        left join (select a.* from price_salebody_relation a where a.is_delete = 0 ) xsztdzb
        ON sso.company_id = xsztdzb.company_id
        AND sso.sale_body = xsztdzb.sale_body_des
        inner join scm_variety_to_pt_gp svtp
        on sso.company_id = svtp.company_id
        and sso.product_code = svtp.product_group

        left join (SELECT a.company_id,
        a.product_class,
        a.product_line_class,
        a.product_class_crude,
        a.product_class_fine,
        a.product_grade
        FROM REPORT_PRODUCT_CLASS_LEVEL a
        where a.status = '0'
        union all
        SELECT b.company_id,
        b.second_code,
        b.product_line_class,
        b.product_class_crude,
        b.product_class_fine,
        b.product_grade
        FROM REPORT_PRODUCT_CLASS_LEVEL b
        where b.status = '0') rpcl
        on sso.company_id = rpcl.company_id
        and sso.product_type = rpcl.product_class
        where
        settle.fkdat   &gt;= to_date(#{startTime}, 'yyyy-mm-dd hh24:mi:ss')
        and settle.fkdat  &lt;= to_date(#{endTime}, 'yyyy-mm-dd hh24:mi:ss')

        order by settle.id desc
        ) t
        where t.order_type_describe not in
        (select distinct cfd.data_name
        from crm_filter_data cfd
        where cfd.data_type = '2'
        and cfd.status = '0'
        and cfd.company_id = t.company_id)
        and t.saler_name not in
        (select cfd.data_name
        from crm_filter_data cfd
        where cfd.data_type = '1'
        and cfd.status = '0'
        and cfd.company_id = t.company_id
        and instr(concat(t.product_line, t.company_id),
        concat(cfd.product_line, cfd.company_id))  &gt; 0)
        AND t.sale_group NOT IN (SELECT cfd.data_name
        FROM crm_filter_data cfd
        WHERE cfd.company_id = t.company_id
        AND cfd.data_type = 9
        AND cfd.status = 0)
        <if test="pz != null and pz !=''">
            and  t.name=#{pz}
        </if>

        group by  t.name






    </select>


    <select id="getzrbm" resultType="map">
        select companyname,fkimg,bz,pzgl,mbl,pzgl/mbl wcbl from (select * from (select  companyname||'分公司' companyname,
        sum(fkimg)fkimg,
        sum(case when   product_grade = '品种钢' OR product_grade = '高端产品' OR product_grade = '特色战略产品' then fkimg end)pzgl,
        sum(case when   product_grade = '品种钢' OR product_grade = '高端产品' OR product_grade = '特色战略产品' then fkimg end)/
        sum(fkimg) bz, '2' sx from (SELECT
        distinct
        decode(settle.company_id,
        9580,
        '唐钢',
        9727,
        '邯钢',
        9193,
        '宣钢',
        9196,
        '承钢',
        1932,
        '舞钢',
        8110,
        '石钢',
        8493,
        '衡板',
        7778,
        '邯宝') AS companyname,
        settle.company_id,
        xsztdzb.sale_body,
        rpcl.product_grade,
        settle.fkimg,
        settle.id,
        settle.fkdat,
        sso.order_mount,
        sso.order_type_describe,
        sso.saler_name,
        sso.sale_group,
        (select max(DATA.Name)
        from scm_delivery_detail detail
        JOIN crm_resource_data DATA
        ON DATA.full_name = detail.ext
        AND DATA.company_id = detail.company_id
        AND DATA.TYPE = 3
        AND DATA.parent_name IS NOT NULL
        where settle.company_id = detail.company_id
        and settle.vgbel = detail.deliv_numb
        and settle.vgpos = detail.deliv_item
        and ( <![CDATA[ detail.delivery_delete <> 'X' ]]> or
        detail.delivery_delete is null)
        ) name,
        (select max(detail.ext)
        from scm_delivery_detail detail
        where settle.company_id = detail.company_id
        and settle.vgbel = detail.deliv_numb
        and settle.vgpos = detail.deliv_item
        and ( <![CDATA[ detail.delivery_delete <> 'X' ]]>  or
        detail.delivery_delete is null)) product_line
        FROM scm_steel_settle settle
        left join scm_sale_order sso
        on settle.company_id = sso.company_id
        and settle.aubel = sso.order_no
        and settle.aupos = sso.order_row
        left join (select a.* from price_salebody_relation a where a.is_delete = 0 ) xsztdzb
        ON sso.company_id = xsztdzb.company_id
        AND sso.sale_body = xsztdzb.sale_body_des
        inner join scm_variety_to_pt_gp svtp
        on sso.company_id = svtp.company_id
        and sso.product_code = svtp.product_group

        left join (SELECT a.company_id,
        a.product_class,
        a.product_line_class,
        a.product_class_crude,
        a.product_class_fine,
        a.product_grade
        FROM REPORT_PRODUCT_CLASS_LEVEL a
        where a.status = '0'
        union all
        SELECT b.company_id,
        b.second_code,
        b.product_line_class,
        b.product_class_crude,
        b.product_class_fine,
        b.product_grade
        FROM REPORT_PRODUCT_CLASS_LEVEL b
        where b.status = '0') rpcl
        on sso.company_id = rpcl.company_id
        and sso.product_type = rpcl.product_class
        where
        settle.fkdat   &gt;= to_date(#{startTime}, 'yyyy-mm-dd hh24:mi:ss')
        and settle.fkdat  &lt;= to_date(#{endTime}, 'yyyy-mm-dd hh24:mi:ss')
        order by settle.id desc
        ) t
        where t.order_type_describe not in
        (select distinct cfd.data_name
        from crm_filter_data cfd
        where cfd.data_type = '2'
        and cfd.status = '0'
        and cfd.company_id = t.company_id)
        and t.saler_name not in
        (select cfd.data_name
        from crm_filter_data cfd
        where cfd.data_type = '1'
        and cfd.status = '0'
        and cfd.company_id = t.company_id
        and instr(concat(t.product_line, t.company_id),
        concat(cfd.product_line, cfd.company_id))  &gt; 0)
        AND t.sale_group NOT IN (SELECT cfd.data_name
        FROM crm_filter_data cfd
        WHERE cfd.company_id = t.company_id
        AND cfd.data_type = 9
        AND cfd.status = 0)
        group by  t.companyname
        union all(
        select  name||'公司' companyname,
        sum(fkimg)fkimg,
        sum(case when   product_grade = '品种钢' OR product_grade = '高端产品' OR product_grade = '特色战略产品' then fkimg end)pzgl,
        sum(case when   product_grade = '品种钢' OR product_grade = '高端产品' OR product_grade = '特色战略产品' then fkimg end)/
        sum(fkimg) bz,'1' sx from (SELECT
        distinct
        settle.company_id,
        xsztdzb.sale_body,
        rpcl.product_grade,
        settle.fkimg,
        settle.id,
        settle.fkdat,
        sso.order_mount,
        sso.order_type_describe,
        sso.saler_name,
        sso.sale_group,
        (select max(B.VARIETY)
        from scm_sale_order sso
        JOIN scm_variety_to_pt_gp B
        ON sso.product_code = B.product_group
        and sso.company_id = B.company_id
        where sso.order_no = settle.aubel
        and sso.ORDER_ROW = settle.AUPOS
        AND sso.company_id = settle.company_id
        ) name,
        (select max(detail.ext)
        from scm_delivery_detail detail
        where settle.company_id = detail.company_id
        and settle.vgbel = detail.deliv_numb
        and settle.vgpos = detail.deliv_item
        and ( <![CDATA[ detail.delivery_delete <> 'X' ]]>  or
        detail.delivery_delete is null)) product_line
        FROM scm_steel_settle settle
        left join scm_sale_order sso
        on settle.company_id = sso.company_id
        and settle.aubel = sso.order_no
        and settle.aupos = sso.order_row
        left join (select a.* from price_salebody_relation a where a.is_delete = 0 ) xsztdzb
        ON sso.company_id = xsztdzb.company_id
        AND sso.sale_body = xsztdzb.sale_body_des
        inner join scm_variety_to_pt_gp svtp
        on sso.company_id = svtp.company_id
        and sso.product_code = svtp.product_group

        left join (SELECT a.company_id,
        a.product_class,
        a.product_line_class,
        a.product_class_crude,
        a.product_class_fine,
        a.product_grade
        FROM REPORT_PRODUCT_CLASS_LEVEL a
        where a.status = '0'
        union all
        SELECT b.company_id,
        b.second_code,
        b.product_line_class,
        b.product_class_crude,
        b.product_class_fine,
        b.product_grade
        FROM REPORT_PRODUCT_CLASS_LEVEL b
        where b.status = '0') rpcl
        on sso.company_id = rpcl.company_id
        and sso.product_type = rpcl.product_class
        where
        settle.fkdat   &gt;= to_date(#{startTime}, 'yyyy-mm-dd hh24:mi:ss')
        and settle.fkdat  &lt;= to_date(#{endTime}, 'yyyy-mm-dd hh24:mi:ss')

        order by settle.id desc
        ) t
        where t.order_type_describe not in
        (select distinct cfd.data_name
        from crm_filter_data cfd
        where cfd.data_type = '2'
        and cfd.status = '0'
        and cfd.company_id = t.company_id)
        and t.saler_name not in
        (select cfd.data_name
        from crm_filter_data cfd
        where cfd.data_type = '1'
        and cfd.status = '0'
        and cfd.company_id = t.company_id
        and instr(concat(t.product_line, t.company_id),
        concat(cfd.product_line, cfd.company_id))  &gt; 0)
        AND t.sale_group NOT IN (SELECT cfd.data_name
        FROM crm_filter_data cfd
        WHERE cfd.company_id = t.company_id
        AND cfd.data_type = 9
        AND cfd.status = 0)
        group by  t.name
        )
        )c
        left join
        (select
        SAU.ACCOUNTABILITY_UNIT_NAME zrbm,
        JANUARY +
        FEBRUARY +
        MARCH +
        APRIL +
        MAY +
        JUNE +
        JULY +
        AUGUST +
        SEPTEMBER +
        OCTOBER +
        NOVEMBER +
        DECEMBER mbl
        from SCM_ACCOUNTABILITY_UNIT_MANAGE SAU
        LEFT JOIN SCM_TARGET_QUANTITY_MANAGEMENT SQM
        on SAU.ACCOUNTABILITY_UNIT_CODE = SQM.RESPONSIBILITY_UNIT
        where SQM.DELETESTATUS='0' order by zrbm ) mb
        on mb.zrbm = c.companyName) order by sx

    </select>


    <select id="getjszl" resultType="map">
        SELECT decode(settle.company_id,
        9580,
        '唐钢',
        9727,
        '邯钢',
        9193,
        '宣钢',
        9196,
        '承钢',
        1932,
        '舞钢',
        8110,
        '石钢',
        8493,
        '衡板',
        7778,
        '邯宝') AS companyname,
        settle.company_id,
        round(SUM(settle.fkimg),2),
        SUM(KZWI6) AS jsjg,
        round(SUM(KZWI6)/SUM(settle.fkimg),2) jsjj
        FROM scm_steel_settle settle
        left JOIN scm_delivery_detail detail
        ON settle.aubel = detail.order_no
        AND settle.aupos = detail.order_item
        JOIN scm_sale_order sso
        ON sso.order_no = settle.aubel
        AND sso.company_id = settle.company_id
        GROUP BY settle.company_id
        ORDER BY company_id
    </select>

    <select id="getpzjszl" resultType="map">
      SELECT
    B.VARIETY,
    round(SUM(settle.fkimg),2) jsl,
    SUM(KZWI6) AS jsjg,
    round(SUM(KZWI6)/SUM(settle.fkimg),2) jsjj
    FROM scm_steel_settle settle
    JOIN scm_sale_order sso
    on sso.order_no = settle.aubel
    and sso.ORDER_ROW = settle.AUPOS
    AND sso.company_id = settle.company_id
    JOIN scm_variety_to_pt_gp B
    ON sso.product_code = B.product_group
    and sso.company_id = B.company_id
    left join (SELECT a.company_id,
    a.product_class,
    a.product_line_class,
    a.product_class_crude,
    a.product_class_fine,
    a.product_grade
    FROM REPORT_PRODUCT_CLASS_LEVEL a
    where a.status = '0'
    union all
    SELECT b.company_id,
    b.second_code,
    b.product_line_class,
    b.product_class_crude,
    b.product_class_fine,
    b.product_grade
    FROM REPORT_PRODUCT_CLASS_LEVEL b
    where b.status = '0') rpcl
    on sso.company_id = rpcl.company_id
    and sso.product_type = rpcl.product_class
    where settle.fkdat   &gt;= to_date(#{startTime},'yyyy-mm-dd hh24:mi:ss')
    AND settle.fkdat   &lt;= to_date(#{endTime},'yyyy-mm-dd hh24:mi:ss')

    group by  B.VARIETY
    </select>

    <select id="getpzgjswc" resultType="map">
      select name ,jsl,pzgl,round(pzgl/jsl*100,2) wcl from (
        SELECT
        B.VARIETY name,
        SUM(case when rpcl.product_grade = '品种钢'
        OR rpcl.product_grade = '高端产品'
        OR rpcl.product_grade = '特色战略产品' then fkimg end) pzgl,
        round(SUM(settle.fkimg),2) jsl
        FROM scm_steel_settle settle
        JOIN scm_sale_order sso
        on sso.order_no = settle.aubel
        and sso.ORDER_ROW = settle.AUPOS
        AND sso.company_id = settle.company_id
        JOIN scm_variety_to_pt_gp B
        ON sso.product_code = B.product_group
        and sso.company_id = B.company_id
        left join (SELECT a.company_id,
        a.product_class,
        a.product_line_class,
        a.product_class_crude,
        a.product_class_fine,
        a.product_grade
        FROM REPORT_PRODUCT_CLASS_LEVEL a
        where a.status = '0'
        union all
        SELECT b.company_id,
        b.second_code,
        b.product_line_class,
        b.product_class_crude,
        b.product_class_fine,
        b.product_grade
        FROM REPORT_PRODUCT_CLASS_LEVEL b
        where b.status = '0') rpcl
        on sso.company_id = rpcl.company_id
        and sso.product_type = rpcl.product_class
        where settle.fkdat &gt;= to_date(#{startTime}, 'yyyy-mm-dd hh24:mi:ss')
        and settle.fkdat &lt;=  to_date(#{endTime}, 'yyyy-mm-dd hh24:mi:ss')
        group by  B.VARIETY ) a
   </select>

    <select id="getzgsjswc" resultType="map">
        select companyid,companyname name ,sum(fkimg) jsl,sum(pzgl) pzgl,round(sum(pzgl)/sum(fkimg)*100,2) wcl from
        (SELECT DISTINCT decode(settle.company_id,
        9580,
        '唐钢',
        9727,
        '邯钢',
        9193,
        '宣钢',
        9196,
        '承钢',
        1932,
        '舞钢',
        8110,
        '石钢',
        8493,
        '衡板',
        7778,
        '邯宝') AS companyname,
        settle.company_id companyid,
        settle.fkimg AS fkimg,
        case when rpcl.product_grade = '品种钢'
        OR rpcl.product_grade = '高端产品'
        OR rpcl.product_grade = '特色战略产品' then settle.fkimg end pzgl
        FROM scm_steel_settle settle
        LEFT JOIN scm_sale_order sso
        on sso.order_no = settle.aubel
        and sso.ORDER_ROW = settle.AUPOS
        AND sso.company_id = settle.company_id
        left join (SELECT a.company_id,
        a.product_class,
        a.product_line_class,
        a.product_class_crude,
        a.product_class_fine,
        a.product_grade
        FROM REPORT_PRODUCT_CLASS_LEVEL a
        where a.status = '0'
        union all
        SELECT b.company_id,
        b.second_code,
        b.product_line_class,
        b.product_class_crude,
        b.product_class_fine,
        b.product_grade
        FROM REPORT_PRODUCT_CLASS_LEVEL b
        where b.status = '0') rpcl
        on sso.company_id = rpcl.company_id
        and sso.product_type = rpcl.product_class
        where settle.fkdat   &gt;= to_date(#{startTime},'yyyy-mm-dd hh24:mi:ss')
       	AND settle.fkdat   &lt;= to_date(#{endTime},'yyyy-mm-dd hh24:mi:ss')
        )
        group by companyname,companyid
        order by decode(companyid,
        9580,
        1,
        9727,
        2,
        7778,
        3,
        9193,
        4,
        9196,
        5,
        1932,
        6,
        8110,
        7,
        8493,
        8,
        null,
        9) asc
</select>

    <select id="getzyjh" resultType="map">
            select *
  from (select '1' yf,year || '1月' rq,PZ_NAME pz,
               cx_name cx,
               fl_name,
               sum(JAN_MONTH) jhl
          from crm_resource_allocation
           where STATUS = '0'
         group by year, PZ_NAME, cx_name, fl_name
        union all
        select '2' yf,year || '2月' rq,PZ_NAME pz,
               cx_name cx,
               fl_name,
               sum(FEB_MONTH) jhl
          from crm_resource_allocation
            where STATUS = '0'
         group by year, PZ_NAME, cx_name, fl_name
        union all
        select '3' yf,year || '3月' rq,PZ_NAME pz,
               cx_name cx,
               fl_name,
               sum(MAR_MONTH) jhl
          from crm_resource_allocation
            where STATUS = '0'
         group by year, PZ_NAME, cx_name, fl_name
        union all
        select '4' yf,year || '4月' rq,PZ_NAME pz,
               cx_name cx,
               fl_name,
               sum(APR_MONTH) jhl
          from crm_resource_allocation
           where STATUS = '0'
         group by year, PZ_NAME, cx_name, fl_name
        union all
        select '5' yf,year || '5月' rq,PZ_NAME pz,
               cx_name cx,
               fl_name,
               sum(MAY_MONTH) jhl
          from crm_resource_allocation
              where STATUS = '0'
         group by year, PZ_NAME, cx_name, fl_name
        union all
        select '6' yf,year || '6月' rq,PZ_NAME pz,
               cx_name cx,
               fl_name,
               sum(JUN_MONTH) jhl
          from crm_resource_allocation
            where STATUS = '0'
         group by year, PZ_NAME, cx_name, fl_name
        union all
        select '7' yf,year || '7月' rq,PZ_NAME pz,
               cx_name cx,
               fl_name,
               sum(JUL_MONTH) jhl
          from crm_resource_allocation
            where STATUS = '0'
         group by year, PZ_NAME, cx_name, fl_name
        union all
        select '8' yf,year || '8月' rq,PZ_NAME pz,
               cx_name cx,
               fl_name,
               sum(AUG_MONTH) jhl
          from crm_resource_allocation
           where STATUS = '0'
         group by year, PZ_NAME, cx_name, fl_name
        union all
        select '9' yf,year || '9月' rq,PZ_NAME pz,
               cx_name cx,
               fl_name,
               sum(SEP_MONTH) jhl
          from crm_resource_allocation
            where STATUS = '0'
         group by year, PZ_NAME, cx_name, fl_name
        union all
        select '10' yf,year || '10月' rq,PZ_NAME pz,
               cx_name cx,
               fl_name,
               sum(OCT_MONTH) jhl
          from crm_resource_allocation
            where STATUS = '0'
         group by year, PZ_NAME, cx_name, fl_name
        union all
        select '11' yf,year || '11月' rq,PZ_NAME pz,
               cx_name cx,
               fl_name,
               sum(NOV_MONTH) jhl
          from crm_resource_allocation
          where STATUS = '0'
         group by year, PZ_NAME, cx_name, fl_name
        union all
        select '12' yf,year || '12月' rq,PZ_NAME pz,
               cx_name cx,
               fl_name,
               sum(DEC_MONTH) jhl
          from crm_resource_allocation
            where STATUS = '0'
         group by year, PZ_NAME, cx_name, fl_name) a

 where
        rq like  '%'||#{nf}||'%'
        <if test="yf != ''">
           and yf = #{yf}
         </if>
        <if test="pz != ''">
           and pz = #{pz}
        </if>
        <if test="cx != ''">
        and cx = #{cx}
        </if>
        <if test="xszt != ''">
        and fl_name = #{xszt}
        </if>
        ORDER BY    fl_name , cx ,
        "DECODE"(pz,'热板','冷板','宽厚板','棒线','型材')
    </select>


    <select id="getzyjhcxtjpz" resultType="map">
        select distinct pz_name pz
        from crm_resource_allocation pz_name
    </select>

    <select id="getzyjhcxtjcx" resultType="map">
        select distinct cx_name cx
        from crm_resource_allocation
        <if test="pz != ''">
            where pz_name = #{pz}
        </if>
    </select>

    <select id="getzyjhcxtjxszt" resultType="map">
        select distinct fl_name xszt
        from crm_resource_allocation pz_name
    </select>

    <select id="getpzhtjd" resultType="map">
      select pzName,
       case  when hjhtl is null then 0 else hjhtl end hjhtl,
       case  when hjjhl is null then 0 else hjjhl end hjjhl,
       case when hjjhl =0 then 0 when hjhtl / hjjhl is null then 0 else

        ROUND (
        hjhtl / hjjhl * 100,
        2

        )
        END AS schedulehj,
        case  when zygshtl is null then 0 else zygshtl end zygshtl,
        case  when zyfgshtl is null then 0 else zyfgshtl end zyfgshtl,
         case  when planNumxsz is null then 0 else planNumxsz end planNumxsz,
       case when planNumxsz =0 then 0 when htlzgs/planNumxsz is null then 0 else

        ROUND (
        htlzgs/planNumxsz * 100,
        2
        )

        END AS schedulexsz,
        case when htlzgs-planNumxsz is null then 0 else htlzgs-planNumxsz end jdxsz,
        case  when zgshtl is null then 0 else zgshtl end zgshtl,
         case  when planNumzgs is null then 0 else planNumzgs end planNumzgs,
       case when planNumzgs =0 then 0 when htlzgs/planNumzgs is null then 0 else

        ROUND (
        htlzgs/planNumzgs * 100,
        2
        )

        END AS schedulezgs,
        case when zgshtl-planNumzgs is null then 0 else htlzgs-planNumzgs end jdzgs,
        case  when ckhtl is null then 0 else ckhtl end ckhtl,
         case  when planNumck is null then 0 else planNumck end planNumck,
       case when planNumck =0 then 0 when ckhtl/planNumck is null then 0 else

        ROUND (
        ckhtl/planNumck * 100,
        2
        )

        END AS scheduleck,
        case when ckhtl-planNumck is null then 0 else ckhtl-planNumck end jdck
  from (select distinct ht.pzName pzName,
                        sum(ht.orderMount) hjhtl,
                        hjjhl,
                        sum(case
                              when ht.saleBody = '专业公司' or ht.saleBody = '分公司' then
                               ht.orderMount
                            end) htlzgs,
                        sum(case
                              when ht.saleBody = '专业公司' then
                               ht.orderMount
                            end) zygshtl,
                        sum(case
                               when ht.saleBody = '分公司' then
                                ht.orderMount
                             end) zyfgshtl, sum(case
                          when ht.saleBody = '技术中心' or
                               ht.saleBody = '事业部' or
                               ht.saleBody = '子公司' or
                               ht.saleBody = '自办公司' or
                               ht.saleBody = '现货' then
                               ht.orderMount
                        end) zgshtl,
                        sum(case
                              when ht.saleBody = '出口' then
                               ht.orderMount
                            end) ckhtl,
                        jh.planNumxsz planNumxsz,
                        jh.planNumzgs planNumzgs,
                        jh.planNumck planNumck

          from (SELECT distinct svtp.variety pzName,
                                xsztdzb.sale_body saleBody,
                                sso.ORDER_MOUNT   orderMount
                from scm_sale_order sso
                   inner join scm_variety_to_pt_gp svtp
                   on sso.company_id = svtp.company_id
                   and sso.product_code = svtp.product_group
                 left join (select a.*
                              from price_salebody_relation a
                             where a.is_delete = 0) xsztdzb
                    ON sso.company_id = xsztdzb.company_id
                   AND sso.sale_body = xsztdzb.sale_body_des

                 WHERE 1 = 1
                    <if test="pzName != null and pzName != ''">
                        and svtp.variety = #{pzName}
                    </if>
                   and instr(sso.dj_date, #{date}) > 0
                   and sso.order_type_describe not in
       (select distinct cfd.data_name
          from crm_filter_data cfd
         where cfd.data_type = '2'
           and cfd.status = '0'
           and cfd.company_id = sso.company_id)
   and sso.saler_name not in
       (select cfd.data_name
          from crm_filter_data cfd
         where cfd.data_type = '1'
           and cfd.status = '0'
           and cfd.company_id = sso.company_id)

   AND sso.sale_group NOT IN (SELECT cfd.data_name
                              FROM crm_filter_data cfd
                             WHERE cfd.company_id = sso.company_id
                               AND cfd.data_type = 9
                               AND cfd.status = 0)
        and xsztdzb.sale_body <![CDATA[ != ]]> '品种钢'
                ) ht
          left join (select PZ_NAME pzName,
                           sum(planNum) hjjhl,
                           sum(case
                                 when fl_name = '销售总公司' then
                                  planNum
                               end) planNumxsz,
                           sum(case
                                 when fl_name = '出口' then
                                  planNum
                               end) planNumck,
                           sum(case
                                 when fl_name = '子公司其他' or fl_name = '技术中心、事业部' or fl_name = '现货' then
                                  planNum
                               end) planNumzgs
                      from (SELECT distinct PZ_NAME, MAR_MONTH planNum, fl_name
                              FROM crm_resource_allocation
                             where year = #{year}
                              )
                     group by PZ_NAME) jh
            on ht.pzName = jh.pzName
         group by ht.pzName, hjjhl, jh.planNumxsz, jh.planNumzgs, jh.planNumck)
         order by decode(pzName,'热板',1,'冷板',2,'宽厚板',3,'棒线',4,'型带',5)
    </select>

    <select id="getcxhtjd" resultType="map">
        select dName,
        case
        when hjhtl is null then
        0
        else
        hjhtl
        end hjhtl,
        case
        when hjjhl is null then
        0
        else
        hjjhl
        end hjjhl,
        case
        when hjjhl = 0 then
        0
        when hjhtl / hjjhl is null then
        0
        else
        ROUND(hjhtl / hjjhl * 100, 2)
        END AS schedulehj,
        case
        when zygshtl is null then
        0
        else
        zygshtl
        end zygshtl,
        case
        when zyfgshtl is null then
        0
        else
        zyfgshtl
        end zyfgshtl,
        case
        when planNumxsz is null then
        0
        else
        planNumxsz
        end planNumxsz,
        case
        when planNumxsz = 0 then
        0
        when htlzgs / planNumxsz is null then
        0
        else
        ROUND(htlzgs / planNumxsz * 100, 2)
        END AS schedulexsz,
        case
        when htlzgs = 0 or htlzgs is null then
        -planNumxsz
        when planNumxsz = 0 or planNumxsz is null then
        htlzgs
        else
        htlzgs - planNumxsz
        end jdxsz,
        case
        when zgshtl is null then
        0
        else
        zgshtl
        end zgshtl,
        case
        when planNumzgs is null then
        0
        else
        planNumzgs
        end planNumzgs,
        case
        when planNumzgs = 0 then
        0
        when htlzgs / planNumzgs is null then
        0
        else
        ROUND(htlzgs / planNumzgs * 100, 2)
        END AS schedulezgs,
        case
        when zgshtl = 0 or zgshtl is null then
        -planNumzgs
        when planNumzgs = 0 or planNumzgs is null then
        zgshtl
        else
        htlzgs - planNumzgs
        end jdzgs,
        case
        when ckhtl is null then
        0
        else
        ckhtl
        end ckhtl,
        case
        when planNumck is null then
        0
        else
        planNumck
        end planNumck,
        case
        when planNumck = 0 then
        0
        when ckhtl / planNumck is null then
        0
        else
        ROUND(ckhtl / planNumck * 100, 2)
        END AS scheduleck,
        case
        when ckhtl = 0 or ckhtl is null then
        -planNumck
        when planNumck = 0 or planNumck is null then
        ckhtl
        else
        ckhtl - planNumck
        end jdck
        from (select distinct ht.dName dName,
        sum(ht.orderMount) hjhtl,
        hjjhl,
        sum(case
        when ht.saleBody = '专业公司' or ht.saleBody = '分公司' then
        ht.orderMount
        end) htlzgs,
        sum(case
        when ht.saleBody = '专业公司' then
        ht.orderMount
        end) zygshtl,
        sum(case
        when ht.saleBody = '分公司' then
        ht.orderMount
        end) zyfgshtl,
        sum(case
        when ht.saleBody = '技术中心' or ht.saleBody = '事业部' or
        ht.saleBody = '子公司' or ht.saleBody = '自办公司' or
        ht.saleBody = '现货' then
        ht.orderMount
        end) zgshtl,
        sum(case
        when ht.saleBody = '出口' then
        ht.orderMount
        end) ckhtl,
        jh.planNumxsz planNumxsz,
        jh.planNumzgs planNumzgs,
        jh.planNumck planNumck

        from (SELECT case
        when sso.company_id = '9580' and
        sso.product_code = '01' and
        sso.sale_group = '2005' then
        '唐钢1700/1810'
        when sso.company_id = '9580' and
        sso.product_code = '02' and
        sso.sale_group = '2005' then
        '唐钢酸洗'
        when sso.company_id = '9580' and
        sso.product_code = '02' and
        sso.sale_group = '2003' and
        sso.material_group_info = '冷轧低碳钢带（罩退）' then
        '唐钢一冷罩退'
        when sso.company_id = '9580' and
        sso.product_code = '02' and
        sso.sale_group = '2003' and
        sso.material_group_info = '连续热镀锌钢带（热轧基板）' then
        '唐钢热基镀锌'
        when sso.company_id = '9580' and
        sso.product_code = '02' and
        sso.sale_group = '2003' and
        sso.material_group_info = '连续热镀锌钢带（冷轧基板）' then
        '唐钢一冷冷基镀锌'
        when sso.company_id = '9580' and
        sso.product_code = '02' and
        sso.sale_group = '2003' and
        sso.material_group_info = '冷轧硬钢带' then
        '唐钢一冷酸轧'
        when sso.company_id = '9580' and
        sso.product_code = '02' and
        sso.sale_group = '1500' and
        sso.material_group_info = '冷轧硬钢带' then
        '唐钢二冷酸轧'
        when sso.company_id = '9580' and
        sso.product_code = '02' and
        sso.sale_group = '1500' and
        sso.material_group_info = '冷轧低碳钢带（连退）' then
        '唐钢新区连退'
        when sso.company_id = '9580' and
        sso.product_code = '02' and
        sso.sale_group = '1500' and
        sso.material_group_info = '连续热镀锌钢带（冷轧基板）' then
        '唐钢新区镀锌'
        when sso.company_id = '9580' and
        sso.product_code = '02' and
        sso.sale_group = '2003' and
        (sso.material_group_info <![CDATA[ != ]]> '冷轧低碳钢带（罩退）' and
        sso.material_group_info <![CDATA[ != ]]> '连续热镀锌钢带（热轧基板）' and
        sso.material_group_info <![CDATA[ != ]]> '连续热镀锌钢带（冷轧基板）' and
        sso.material_group_info <![CDATA[ != ]]> '冷轧硬钢带') or
        sso.sale_group = '1500' and
        (sso.material_group_info <![CDATA[ != ]]> '冷轧硬钢带' and
        sso.material_group_info <![CDATA[ != ]]> '冷轧低碳钢带（连退）' and
        sso.material_group_info <![CDATA[ != ]]> '连续热镀锌钢带（冷轧基板）') then
        '唐钢其他'
        when sso.company_id = '9580' and
        sso.product_code = '03' then
        '唐钢棒材'
        when sso.company_id = '9580' and
        sso.product_code = '04' then
        '唐钢线材'
        when sso.company_id = '9580' and
        sso.product_code = '05' and
        sso.sale_group = '2002' and
        sso.MATERIAL_CODE like '935%' then
        '唐钢中型'
        when sso.company_id = '9580' and
        sso.product_code = '01' and
        sso.sale_group = '4000' then
        '唐钢1580热轧线'
        when sso.company_id = '9580' and
        sso.product_code in ('21', '22', '23') then
        '唐钢中厚板'
        when sso.company_id = '9580' and
        sso.product_code = '05' and
        sso.sale_group = '2002' and
        sso.MATERIAL_CODE like '941%' then
        '唐钢大型'
        when sso.company_id = '7778' and
        sso.product_code = 'I' then
        '邯钢2250'
        when sso.company_id = '9727' and
        sso.product_code = '20' then
        '邯钢CSP'
        when sso.company_id = '9727' and
        sso.product_code = '21' then
        '邯钢酸洗'
        when sso.company_id = '9727' and
        sso.product_code = '31' then
        '邯钢一冷罩退'
        when sso.company_id = '9727' and
        sso.product_code = '22' then
        '邯钢热基镀锌'
        when sso.company_id = '9727' and
        sso.product_code = '33' and
        sso.material_code not like 'C4%' then
        '邯钢热基镀锌'
        when sso.company_id = '9727' and
        sso.product_code = '33' and
        sso.material_code like 'C4%' then
        '邯钢一冷冷基镀锌'
        when sso.company_id = '9727' and
        sso.product_code = '35' then
        '邯钢电镀锌'
        when sso.company_id = '9727' and
        sso.product_code = '34' then
        '邯钢彩涂'
        when sso.company_id = '9727' and
        sso.product_code = '30' then
        '邯钢酸轧'
        when sso.company_id = '7778' and
        sso.product_code = 'Z' then
        '邯宝酸轧'
        when sso.company_id = '7778' and
        sso.product_code = 'L' then
        '邯钢西区连退'
        when sso.company_id = '7778' and
        sso.product_code = 'M' then
        '邯钢西区镀锌'
        when sso.company_id = '9727' and
        sso.product_code = '10' then
        '邯钢3000/3500'
        when sso.company_id = '9727' and
        sso.product_code = '01' and
        sso.sale_body != '优特钢' then
        '邯钢棒材'
        when sso.company_id = '9727' and
        sso.product_code = '02' and
        sso.sale_body != '优特钢' then
        '邯钢线材'
        when sso.company_id = '9727' and
        sso.product_code = '02' and
        sso.sale_body = '优特钢' then
        '邯钢新钢轧线材'
        when sso.company_id = '9727' and
        sso.product_code = '01' and
        sso.sale_body = '优特钢' then
        '邯钢新钢轧棒材'
        when sso.company_id = '9727' and
        sso.product_code = '03' then
        '邯钢新钢轧型材'
        when sso.company_id = '9193' and
        sso.product_code in ('01', '02') then
        '宣钢棒材'
        when sso.company_id = '9193' and
        sso.product_code = '03' then
        '宣钢一高线、二高线'
        when sso.company_id = '9193' and
        sso.product_code = '08' then
        '宣钢中型'
        when sso.company_id = '9193' and
        sso.product_code = '04' then
        '宣钢带钢'
        when sso.company_id = '9196' and
        sso.product_code = '10' then
        '承钢1780'
        when sso.company_id = '9196' and
        sso.product_code = '40' and
        sso.MATERIAL_CODE like '501%' then
        '承钢棒材'
        when sso.company_id = '9196' and
        sso.product_code = '40' and
        sso.MATERIAL_CODE like '502%' then
        '承钢线材'
        when sso.company_id = '9196' and
        sso.product_code = '50' then
        '承钢中宽带'
        when sso.company_id = '1932' and
        sso.product_code = 'J' then
        '舞钢4100/4200'
        when sso.company_id = '8110' then
        '石钢棒材'
        when sso.company_id = '8493' then
        '衡板冷板'
        end dName,
        xsztdzb.sale_body saleBody,
        sso.ORDER_MOUNT orderMount
        from scm_sale_order sso
        left join (select a.*
        from price_salebody_relation a
        where a.is_delete = 0) xsztdzb
        ON sso.company_id = xsztdzb.company_id
        AND sso.sale_body = xsztdzb.sale_body_des

        WHERE 1 = 1
        and instr(sso.dj_date, #{date}) > 0
        and sso.order_type_describe not in
        (select distinct cfd.data_name
        from crm_filter_data cfd
        where cfd.data_type = '2'
        and cfd.status = '0'
        and cfd.company_id = sso.company_id)
        and sso.saler_name not in
        (select cfd.data_name
        from crm_filter_data cfd
        where cfd.data_type = '1'
        and cfd.status = '0'
        and cfd.company_id = sso.company_id)
        and sso.sale_group not in
        (SELECT sso.sale_group
        FROM crm_filter_data cfd
        where cfd.company_id = sso.company_id
        and instr(sso.sale_group, cfd.data_name, 1, 1) > 0
        and cfd.data_type = 4
        and cfd.status = 0)
        and sso.sale_group <![CDATA[ != ]]> 'C100'
        and sso.sale_group <![CDATA[ != ]]> 'K200'
        and sso.product_info <![CDATA[ != ]]> '连铸坯'
        <if test="cxName != null and cxName != ''">
            and DATA.name = #{cxName}
        </if>) ht
        left join (select cx_NAME,
        sum(planNum) hjjhl,
        sum(case
        when fl_name = '销售总公司' then
        planNum
        end) planNumxsz,
        sum(case
        when fl_name = '出口' then
        planNum
        end) planNumck,
        sum(case
        when fl_name = '子公司其他' or fl_name = '技术中心、事业部' or
        fl_name = '现货' then
        planNum
        end) planNumzgs
        from (SELECT cx_NAME, MAR_MONTH planNum, fl_name
        FROM crm_resource_allocation
        where year = #{year}
        and fl_Name <![CDATA[ != ]]> '品种钢')
        group by cx_NAME) jh
        on ht.dName = jh.cx_name
        group by ht.dName,
        hjjhl,
        jh.planNumxsz,
        jh.planNumzgs,
        jh.planNumck)
    </select>

</mapper>
