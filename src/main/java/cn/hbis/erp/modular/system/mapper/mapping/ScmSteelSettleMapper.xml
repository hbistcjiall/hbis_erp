<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.hbis.erp.modular.system.mapper.ScmSteelSettleMapper">
    <select id="getcx" resultType="map">
        select  companyname,name,
        sum(case when fkdat &gt;= to_date (#{startTime},'yyyy-mm-dd hh24:mi:ss') and fkdat &lt;= to_date (#{endTime},'yyyy-mm-dd hh24:mi:ss') then fkimg end) fkimg,
        sum(case when fkdat &gt;= to_date (#{startTime},'yyyy-mm-dd hh24:mi:ss') and fkdat &lt;= to_date (#{endTime},'yyyy-mm-dd hh24:mi:ss') and product_grade = 'Ʒ�ָ�' OR product_grade = '�߶˲�Ʒ' OR product_grade = '��ɫս�Բ�Ʒ' then fkimg end)pzgl,
        sum(case when fkdat &gt;= to_date (#{startTime},'yyyy-mm-dd hh24:mi:ss') and fkdat &lt;= to_date (#{endTime},'yyyy-mm-dd hh24:mi:ss') and sale_body = 'רҵ��˾' then fkimg end)zyfkimg,
        sum(case when fkdat &gt;= to_date (#{startTime},'yyyy-mm-dd hh24:mi:ss') and fkdat&lt;= to_date (#{endTime},'yyyy-mm-dd hh24:mi:ss') and sale_body = 'רҵ��˾' and (product_grade = 'Ʒ�ָ�' OR product_grade = '�߶˲�Ʒ' OR product_grade = '��ɫս�Բ�Ʒ') then fkimg end)zypzgl,
        sum(case when fkdat &gt;= to_date (#{startTime},'yyyy-mm-dd hh24:mi:ss') and fkdat &lt;= to_date (#{endTime},'yyyy-mm-dd hh24:mi:ss') and sale_body = '�ֹ�˾' then fkimg end)fgsfkimg,
        sum(case when fkdat &gt;= to_date (#{startTime},'yyyy-mm-dd hh24:mi:ss') and fkdat &lt;= to_date (#{endTime},'yyyy-mm-dd hh24:mi:ss') and sale_body = '�ֹ�˾' and (product_grade = 'Ʒ�ָ�' OR product_grade = '�߶˲�Ʒ' OR product_grade = '��ɫս�Բ�Ʒ') then fkimg end) fgsfkimg,
        sum(case when fkdat &gt;= to_date (#{startTime},'yyyy-mm-dd hh24:mi:ss') and fkdat &lt;= to_date (#{endTime},'yyyy-mm-dd hh24:mi:ss') and sale_body = '�ӹ�˾' then fkimg end)zgsfkimg,
        sum(case when fkdat &gt;= to_date (#{startTime},'yyyy-mm-dd hh24:mi:ss') and fkdat &lt;= to_date (#{endTime},'yyyy-mm-dd hh24:mi:ss') and sale_body = '�ӹ�˾' and (product_grade = 'Ʒ�ָ�' OR product_grade = '�߶˲�Ʒ' OR product_grade = '��ɫս�Բ�Ʒ') then fkimg end) zgspzgl,
        sum(case when fkdat &gt;= to_date (#{startTime},'yyyy-mm-dd hh24:mi:ss') and fkdat &lt;= to_date (#{endTime},'yyyy-mm-dd hh24:mi:ss') and sale_body = 'רҵ��˾' and (product_grade = 'Ʒ�ָ�' OR product_grade = '�߶˲�Ʒ' OR product_grade = '��ɫս�Բ�Ʒ') then fkimg end)/
        sum(case when fkdat &gt;= to_date (#{startTime},'yyyy-mm-dd hh24:mi:ss') and fkdat &lt;= to_date (#{endTime},'yyyy-mm-dd hh24:mi:ss') and sale_body = 'רҵ��˾' then fkimg end)zybz,
        sum(case when fkdat &gt;= to_date (#{startTime},'yyyy-mm-dd hh24:mi:ss') and fkdat &lt;= to_date (#{endTime},'yyyy-mm-dd hh24:mi:ss') and sale_body = '�ֹ�˾' and (product_grade = 'Ʒ�ָ�' OR product_grade = '�߶˲�Ʒ' OR product_grade = '��ɫս�Բ�Ʒ') then fkimg end)/
        sum(case when fkdat &gt;= to_date (#{startTime},'yyyy-mm-dd hh24:mi:ss') and fkdat &lt;= to_date (#{endTime},'yyyy-mm-dd hh24:mi:ss') and sale_body = '�ֹ�˾' then fkimg end)fgsbz,
        sum(case when fkdat &gt;= to_date (#{startTime},'yyyy-mm-dd hh24:mi:ss') and fkdat &lt;= to_date (#{endTime},'yyyy-mm-dd hh24:mi:ss') and sale_body = '�ӹ�˾' and (product_grade = 'Ʒ�ָ�' OR product_grade = '�߶˲�Ʒ' OR product_grade = '��ɫս�Բ�Ʒ') then fkimg end)/
        sum(case when fkdat &gt;= to_date (#{startTime},'yyyy-mm-dd hh24:mi:ss') and fkdat &lt;= to_date (#{endTime},'yyyy-mm-dd hh24:mi:ss') and sale_body = '�ӹ�˾' then fkimg end)zgsbz,
        sum(case when fkdat &gt;= to_date (#{startTime},'yyyy-mm-dd hh24:mi:ss') and fkdat &lt; = to_date (#{endTime},'yyyy-mm-dd hh24:mi:ss') and product_grade = 'Ʒ�ָ�' OR product_grade = '�߶˲�Ʒ' OR product_grade = '��ɫս�Բ�Ʒ' then fkimg end)/
        sum(case when fkdat &gt;= to_date (#{startTime},'yyyy-mm-dd hh24:mi:ss') and fkdat &lt;= to_date (#{endTime},'yyyy-mm-dd hh24:mi:ss')then fkimg end) bz,
        sum(case when fkdat &gt;= to_date (#{startTime},'yyyy-mm-dd hh24:mi:ss') and fkdat &lt;= to_date (#{endTime},'yyyy-mm-dd hh24:mi:ss') and product_grade = 'Ʒ�ָ�' OR product_grade = '�߶˲�Ʒ' OR product_grade = '��ɫս�Բ�Ʒ' then fkimg end)/
        sum(case when fkdat &gt;= to_date (#{startTime},'yyyy-mm-dd hh24:mi:ss') and fkdat &lt; = to_date (#{endTime},'yyyy-mm-dd hh24:mi:ss')then fkimg end) sypzb,
        (sum(case when fkdat &gt; = to_date (#{startTime},'yyyy-mm-dd hh24:mi:ss') and fkdat &lt;= to_date (#{endTime},'yyyy-mm-dd hh24:mi:ss') and product_grade = 'Ʒ�ָ�' OR product_grade = '�߶˲�Ʒ' OR product_grade = '��ɫս�Բ�Ʒ' then fkimg end)/
        sum(case when fkdat &gt;= to_date (#{startTime},'yyyy-mm-dd hh24:mi:ss') and fkdat &lt;= to_date (#{endTime},'yyyy-mm-dd hh24:mi:ss')then fkimg end))-(sum(case when fkdat &gt;= to_date (#{startTime},'yyyy-mm-dd') and fkdat &lt;= to_date (#{endagainTime},'yyyy-mm-dd') and product_grade = 'Ʒ�ָ�' OR product_grade = '�߶˲�Ʒ' OR product_grade = '��ɫս�Բ�Ʒ' then fkimg end)/
        sum(case when fkdat &gt;= to_date (#{startTime},'yyyy-mm-dd hh24:mi:ss') and fkdat &lt;= to_date (#{endTime},'yyyy-mm-dd hh24:mi:ss')then fkimg end))hb
        from (SELECT
        distinct decode(settle.company_id,
        9580,
        '�Ƹ�',
        9727,
        '����',
        9193,
        '����',
        9196,
        '�и�',
        1932,
        '���',
        8110,
        'ʯ��',
        8493,
        '���',
        7778,
        '����') AS companyname,
        settle.company_id,
        xsztdzb.sale_body,
        rpcl.product_grade,
        settle.fkimg,
        settle.id,
        settle.fkdat,
        sso.order_mount,
        sso.order_type_describe,
        sso.saler_name,
        sso.sale_group,
        (select max(DATA.Name)
        from scm_delivery_detail detail
        JOIN crm_resource_data DATA
        ON DATA.full_name = detail.ext
        AND DATA.company_id = detail.company_id
        AND DATA.TYPE = 3
        AND DATA.parent_name IS NOT NULL
        where settle.company_id = detail.company_id
        and settle.vgbel = detail.deliv_numb
        and settle.vgpos = detail.deliv_item
        and (<![CDATA[ detail.delivery_delete <> 'X' ]]> or
        detail.delivery_delete is null)) name,
        (select max(detail.ext)
        from scm_delivery_detail detail

        where settle.company_id = detail.company_id
        and settle.vgbel = detail.deliv_numb
        and settle.vgpos = detail.deliv_item
        and (<![CDATA[ detail.delivery_delete <> 'X' ]]> or
        detail.delivery_delete is null))product_line
        FROM scm_steel_settle settle
        left join scm_sale_order sso
        on settle.company_id = sso.company_id
        and settle.aubel = sso.order_no
        and settle.aupos = sso.order_row
        left join (select a.* from price_salebody_relation a where a.is_delete = 0 ) xsztdzb
        ON sso.company_id = xsztdzb.company_id
        AND sso.sale_body = xsztdzb.sale_body_des
        inner join scm_variety_to_pt_gp svtp
        on sso.company_id = svtp.company_id
        and sso.product_code = svtp.product_group

        left join (SELECT a.company_id,
        a.product_class,
        a.product_line_class,
        a.product_class_crude,
        a.product_class_fine,
        a.product_grade
        FROM REPORT_PRODUCT_CLASS_LEVEL a
        where a.status = '0'
        union all
        SELECT b.company_id,
        b.second_code,
        b.product_line_class,
        b.product_class_crude,
        b.product_class_fine,
        b.product_grade
        FROM REPORT_PRODUCT_CLASS_LEVEL b
        where b.status = '0') rpcl
        on sso.company_id = rpcl.company_id
        and sso.product_type = rpcl.product_class
        where
        settle.fkdat &gt;= to_date(#{startTime}, 'yyyy-mm-dd hh24:mi:ss')
        and settle.fkdat &lt;= to_date(#{endTime}, 'yyyy-mm-dd hh24:mi:ss')
        AND (<![CDATA[ xsztdzb.sale_body_des <>'�Ƹ��к�幫˾' ]]> or
        <![CDATA[ xsztdzb.sale_body_des <>'�Ƹֲ���ֹ�˾' ]]>or
        <![CDATA[ xsztdzb.sale_body_des <>'����' ]]> or
        <![CDATA[ xsztdzb.sale_body_des <>'������Ӫ��˾����' ]]>)

        order by settle.id desc) t
        where t.order_type_describe not in
        (select distinct cfd.data_name
        from crm_filter_data cfd
        where cfd.data_type = '2'
        and cfd.status = '0'
        and cfd.company_id = t.company_id)
        and t.saler_name not in
        (select cfd.data_name
        from crm_filter_data cfd
        where cfd.data_type = '1'
        and cfd.status = '0'
        and cfd.company_id = t.company_id
        and instr(concat(t.product_line, t.company_id),
        concat(cfd.product_line, cfd.company_id))  &gt; 0)
        AND t.sale_group NOT IN (SELECT cfd.data_name
        FROM crm_filter_data cfd
        WHERE cfd.company_id = t.company_id
        AND cfd.data_type = 9
        AND cfd.status = 0)
        <if test="cx != null">
            and t.name =#{cx}
        </if>
        <if test="dw != null">
            and t.company_id=#{dw}
        </if>


        and t.name is not null group by  t.companyname,t.name

    </select>


    <select id="getpz" resultType="map">
        select  name,
        sum(case when fkdat &gt;= to_date (#{startTime},'yyyy-mm-dd hh24:mi:ss') and fkdat &lt;= to_date (#{endTime},'yyyy-mm-dd hh24:mi:ss') then fkimg end) fkimg,
        sum(case when fkdat &gt;= to_date (#{startTime},'yyyy-mm-dd hh24:mi:ss') and fkdat &lt;= to_date (#{endTime},'yyyy-mm-dd hh24:mi:ss') and product_grade = 'Ʒ�ָ�' OR product_grade = '�߶˲�Ʒ' OR product_grade = '��ɫս�Բ�Ʒ' then fkimg end)pzgl,
        sum(case when fkdat &gt;= to_date (#{startTime},'yyyy-mm-dd hh24:mi:ss') and fkdat &lt;= to_date (#{endTime},'yyyy-mm-dd hh24:mi:ss') and sale_body = 'רҵ��˾' then fkimg end)zyfkimg,
        sum(case when fkdat &gt;= to_date (#{startTime},'yyyy-mm-dd hh24:mi:ss') and fkdat&lt;= to_date (#{endTime},'yyyy-mm-dd hh24:mi:ss') and sale_body = 'רҵ��˾' and (product_grade = 'Ʒ�ָ�' OR product_grade = '�߶˲�Ʒ' OR product_grade = '��ɫս�Բ�Ʒ') then fkimg end)zypzgl,
        sum(case when fkdat &gt;= to_date (#{startTime},'yyyy-mm-dd hh24:mi:ss') and fkdat &lt;= to_date (#{endTime},'yyyy-mm-dd hh24:mi:ss') and sale_body = '�ֹ�˾' then fkimg end)fgsfkimg,
        sum(case when fkdat &gt;= to_date (#{startTime},'yyyy-mm-dd hh24:mi:ss') and fkdat &lt;= to_date (#{endTime},'yyyy-mm-dd hh24:mi:ss') and sale_body = '�ֹ�˾' and (product_grade = 'Ʒ�ָ�' OR product_grade = '�߶˲�Ʒ' OR product_grade = '��ɫս�Բ�Ʒ') then fkimg end) fgsfkimg,
        sum(case when fkdat &gt;= to_date (#{startTime},'yyyy-mm-dd hh24:mi:ss') and fkdat &lt;= to_date (#{endTime},'yyyy-mm-dd hh24:mi:ss') and sale_body = '�ӹ�˾' then fkimg end)zgsfkimg,
        sum(case when fkdat &gt;= to_date (#{startTime},'yyyy-mm-dd hh24:mi:ss') and fkdat &lt;= to_date (#{endTime},'yyyy-mm-dd hh24:mi:ss') and sale_body = '�ӹ�˾' and (product_grade = 'Ʒ�ָ�' OR product_grade = '�߶˲�Ʒ' OR product_grade = '��ɫս�Բ�Ʒ') then fkimg end) zgspzgl,
        sum(case when fkdat &gt;= to_date (#{startTime},'yyyy-mm-dd hh24:mi:ss') and fkdat &lt;= to_date (#{endTime},'yyyy-mm-dd hh24:mi:ss') and sale_body = 'רҵ��˾' and (product_grade = 'Ʒ�ָ�' OR product_grade = '�߶˲�Ʒ' OR product_grade = '��ɫս�Բ�Ʒ') then fkimg end)/
        sum(case when fkdat &gt;= to_date (#{startTime},'yyyy-mm-dd hh24:mi:ss') and fkdat &lt;= to_date (#{endTime},'yyyy-mm-dd hh24:mi:ss') and sale_body = 'רҵ��˾' then fkimg end)zybz,
        sum(case when fkdat &gt;= to_date (#{startTime},'yyyy-mm-dd hh24:mi:ss') and fkdat &lt;= to_date (#{endTime},'yyyy-mm-dd hh24:mi:ss') and sale_body = '�ֹ�˾' and (product_grade = 'Ʒ�ָ�' OR product_grade = '�߶˲�Ʒ' OR product_grade = '��ɫս�Բ�Ʒ') then fkimg end)/
        sum(case when fkdat &gt;= to_date (#{startTime},'yyyy-mm-dd hh24:mi:ss') and fkdat &lt;= to_date (#{endTime},'yyyy-mm-dd hh24:mi:ss') and sale_body = '�ֹ�˾' then fkimg end)fgsbz,
        sum(case when fkdat &gt;= to_date (#{startTime},'yyyy-mm-dd hh24:mi:ss') and fkdat &lt;= to_date (#{endTime},'yyyy-mm-dd hh24:mi:ss') and sale_body = '�ӹ�˾' and (product_grade = 'Ʒ�ָ�' OR product_grade = '�߶˲�Ʒ' OR product_grade = '��ɫս�Բ�Ʒ') then fkimg end)/
        sum(case when fkdat &gt;= to_date (#{startTime},'yyyy-mm-dd hh24:mi:ss') and fkdat &lt;= to_date (#{endTime},'yyyy-mm-dd hh24:mi:ss') and sale_body = '�ӹ�˾' then fkimg end)zgsbz,
        sum(case when fkdat &gt;= to_date (#{startTime},'yyyy-mm-dd hh24:mi:ss') and fkdat &lt; = to_date (#{endTime},'yyyy-mm-dd hh24:mi:ss') and product_grade = 'Ʒ�ָ�' OR product_grade = '�߶˲�Ʒ' OR product_grade = '��ɫս�Բ�Ʒ' then fkimg end)/
        sum(case when fkdat &gt;= to_date (#{startTime},'yyyy-mm-dd hh24:mi:ss') and fkdat &lt;= to_date (#{endTime},'yyyy-mm-dd hh24:mi:ss')then fkimg end) bz,
        sum(case when fkdat &gt;= to_date (#{startTime},'yyyy-mm-dd hh24:mi:ss') and fkdat &lt;= to_date (#{endTime},'yyyy-mm-dd hh24:mi:ss') and product_grade = 'Ʒ�ָ�' OR product_grade = '�߶˲�Ʒ' OR product_grade = '��ɫս�Բ�Ʒ' then fkimg end)/
        sum(case when fkdat &gt;= to_date (#{startTime},'yyyy-mm-dd hh24:mi:ss') and fkdat &lt; = to_date (#{endagainTime},'yyyy-mm-dd hh24:mi:ss')then fkimg end) sypzb,
        (sum(case when fkdat &gt; = to_date (#{startTime},'yyyy-mm-dd hh24:mi:ss') and fkdat &lt;= to_date (#{endTime},'yyyy-mm-dd hh24:mi:ss') and product_grade = 'Ʒ�ָ�' OR product_grade = '�߶˲�Ʒ' OR product_grade = '��ɫս�Բ�Ʒ' then fkimg end)/
        sum(case when fkdat &gt;= to_date (#{startTime},'yyyy-mm-dd hh24:mi:ss') and fkdat &lt;= to_date (#{endTime},'yyyy-mm-dd hh24:mi:ss')then fkimg end))-(sum(case when fkdat &gt;= to_date (#{startTime},'yyyy-mm-dd') and fkdat &lt;= to_date (#{endTime},'yyyy-mm-dd') and product_grade = 'Ʒ�ָ�' OR product_grade = '�߶˲�Ʒ' OR product_grade = '��ɫս�Բ�Ʒ' then fkimg end)/
        sum(case when fkdat &gt;= to_date (#{startTime},'yyyy-mm-dd hh24:mi:ss') and fkdat &lt;= to_date (#{endagainTime},'yyyy-mm-dd hh24:mi:ss')then fkimg end))hb
        from (SELECT
        distinct
        settle.company_id,
        xsztdzb.sale_body,
        rpcl.product_grade,
        settle.fkimg,
        settle.id,
        settle.fkdat,
        sso.order_mount,
        sso.order_type_describe,
        sso.saler_name,
        sso.sale_group,
        (select max(B.VARIETY)
        from scm_sale_order sso
        JOIN scm_variety_to_pt_gp B
        ON sso.product_code = B.product_group
        and sso.company_id = B.company_id
        where sso.order_no = settle.aubel
        and sso.ORDER_ROW = settle.AUPOS
        AND sso.company_id = settle.company_id
        ) name,
        (select max(detail.ext)
        from scm_delivery_detail detail
        where settle.company_id = detail.company_id
        and settle.vgbel = detail.deliv_numb
        and settle.vgpos = detail.deliv_item
        and (<![CDATA[ detail.delivery_delete <> 'X' ]]> or
        detail.delivery_delete is null)) product_line
        FROM scm_steel_settle settle
        left join scm_sale_order sso
        on settle.company_id = sso.company_id
        and settle.aubel = sso.order_no
        and settle.aupos = sso.order_row
        left join (select a.* from price_salebody_relation a where a.is_delete = 0 ) xsztdzb
        ON sso.company_id = xsztdzb.company_id
        AND sso.sale_body = xsztdzb.sale_body_des
        inner join scm_variety_to_pt_gp svtp
        on sso.company_id = svtp.company_id
        and sso.product_code = svtp.product_group
        left join (SELECT a.company_id,
        a.product_class,
        a.product_line_class,
        a.product_class_crude,
        a.product_class_fine,
        a.product_grade
        FROM REPORT_PRODUCT_CLASS_LEVEL a
        where a.status = '0'
        union all
        SELECT b.company_id,
        b.second_code,
        b.product_line_class,
        b.product_class_crude,
        b.product_class_fine,
        b.product_grade
        FROM REPORT_PRODUCT_CLASS_LEVEL b
        where b.status = '0') rpcl
        on sso.company_id = rpcl.company_id
        and sso.product_type = rpcl.product_class
        where  settle.fkdat &gt;= to_date(#{startTime}, 'yyyy-mm-dd hh24:mi:ss')
        and settle.fkdat &lt;= to_date(#{endTime}, 'yyyy-mm-dd hh24:mi:ss')
        AND (<![CDATA[ xsztdzb.sale_body_des <>'�Ƹ��к�幫˾' ]]> or
        <![CDATA[ xsztdzb.sale_body_des <>'�Ƹֲ���ֹ�˾' ]]>or
        <![CDATA[ xsztdzb.sale_body_des <>'����' ]]> or
        <![CDATA[ xsztdzb.sale_body_des <>'������Ӫ��˾����' ]]>)
        order by settle.id desc) t
        where t.order_type_describe not in
        (select distinct cfd.data_name
        from crm_filter_data cfd
        where cfd.data_type = '2'
        and cfd.status = '0'
        and cfd.company_id = t.company_id)
        and t.saler_name not in
        (select cfd.data_name
        from crm_filter_data cfd
        where cfd.data_type = '1'
        and cfd.status = '0'
        and cfd.company_id = t.company_id
        and instr(concat(t.product_line, t.company_id),
        concat(cfd.product_line, cfd.company_id)) > 0)
        AND t.sale_group NOT IN (SELECT cfd.data_name
        FROM crm_filter_data cfd
        WHERE cfd.company_id = t.company_id
        AND cfd.data_type = 9
        AND cfd.status = 0)
        <if test="pz != null">
            and t.name=#{pz}
        </if>
        and t.name is not null group by  t.name
    </select>


    <select id="getzrbm" resultType="map">
        select companyName,fkimg,pzgl,bz,mbl,pzgl/mbl from(select * from (select  name||'��˾' companyname,
        sum(case when fkdat &gt;= to_date (#{startTime},'yyyy-mm-dd hh24:mi:ss') and fkdat &lt;= to_date (#{endTime},'yyyy-mm-dd hh24:mi:ss') then fkimg end)fkimg,
        sum(case when fkdat &gt;= to_date (#{startTime},'yyyy-mm-dd hh24:mi:ss') and fkdat &lt;= to_date (#{endTime},'yyyy-mm-dd hh24:mi:ss') and product_grade = 'Ʒ�ָ�' OR product_grade = '�߶˲�Ʒ' OR product_grade = '��ɫս�Բ�Ʒ' then fkimg end)pzgl,
        sum(case when fkdat &gt;= to_date (#{startTime},'yyyy-mm-dd hh24:mi:ss') and fkdat &lt;= to_date (#{endTime},'yyyy-mm-dd hh24:mi:ss') and product_grade = 'Ʒ�ָ�' OR product_grade = '�߶˲�Ʒ' OR product_grade = '��ɫս�Բ�Ʒ' then fkimg end)/
        sum(case when fkdat &gt;= to_date (#{startTime},'yyyy-mm-dd hh24:mi:ss') and fkdat &lt;= to_date (#{endTime},'yyyy-mm-dd hh24:mi:ss')then fkimg end) bz
        from (SELECT
        distinct
        settle.company_id,
        xsztdzb.sale_body,
        rpcl.product_grade,
        settle.fkimg,
        settle.id,
        settle.fkdat,
        sso.order_mount,
        sso.order_type_describe,
        sso.saler_name,
        sso.sale_group,
        (select max(B.VARIETY)
        from scm_sale_order sso
        JOIN scm_variety_to_pt_gp B
        ON sso.product_code = B.product_group
        and sso.company_id = B.company_id
        where sso.order_no = settle.aubel
        and sso.ORDER_ROW = settle.AUPOS
        AND sso.company_id = settle.company_id
        ) name,
        (select max(detail.ext)
        from scm_delivery_detail detail
        where settle.company_id = detail.company_id
        and settle.vgbel = detail.deliv_numb
        and settle.vgpos = detail.deliv_item
        and (<![CDATA[ detail.delivery_delete <> 'X' ]]> or
        detail.delivery_delete is null)) product_line
        FROM scm_steel_settle settle
        left join scm_sale_order sso
        on settle.company_id = sso.company_id
        and settle.aubel = sso.order_no
        and settle.aupos = sso.order_row
        left join (select a.* from price_salebody_relation a where a.is_delete = 0 ) xsztdzb
        ON sso.company_id = xsztdzb.company_id
        AND sso.sale_body = xsztdzb.sale_body_des
        inner join scm_variety_to_pt_gp svtp
        on sso.company_id = svtp.company_id
        and sso.product_code = svtp.product_group

        left join (SELECT a.company_id,
        a.product_class,
        a.product_line_class,
        a.product_class_crude,
        a.product_class_fine,
        a.product_grade
        FROM REPORT_PRODUCT_CLASS_LEVEL a
        where a.status = '0'
        union all
        SELECT b.company_id,
        b.second_code,
        b.product_line_class,
        b.product_class_crude,
        b.product_class_fine,
        b.product_grade
        FROM REPORT_PRODUCT_CLASS_LEVEL b
        where b.status = '0') rpcl
        on sso.company_id = rpcl.company_id
        and sso.product_type = rpcl.product_class
        where
        settle.fkdat  &gt;= to_date(#{startTime}, 'yyyy-mm-dd hh24:mi:ss')
        and settle.fkdat  &lt;= to_date(#{endTime}, 'yyyy-mm-dd hh24:mi:ss')
        AND(<![CDATA[ xsztdzb.sale_body_des <>'�Ƹ��к�幫˾' ]]> or
        <![CDATA[ xsztdzb.sale_body_des <>'�Ƹֲ���ֹ�˾' ]]>or
        <![CDATA[ xsztdzb.sale_body_des <>'����' ]]> or
        <![CDATA[ xsztdzb.sale_body_des <>'������Ӫ��˾����' ]]>)
        order by settle.id desc) t
        where t.order_type_describe not in
        (select distinct cfd.data_name
        from crm_filter_data cfd
        where cfd.data_type = '2'
        and cfd.status = '0'
        and cfd.company_id = t.company_id)
        and t.saler_name not in
        (select cfd.data_name
        from crm_filter_data cfd
        where cfd.data_type = '1'
        and cfd.status = '0'
        and cfd.company_id = t.company_id
        and instr(concat(t.product_line, t.company_id),
        concat(cfd.product_line, cfd.company_id))  &gt; 0)
        AND t.sale_group NOT IN (SELECT cfd.data_name
        FROM crm_filter_data cfd
        WHERE cfd.company_id = t.company_id
        AND cfd.data_type = 9
        AND cfd.status = 0)
        and t.name is not null group by  t.name)
        union all(
        select  companyname||'�ֹ�˾' companyname,sum(case when fkdat &gt;= to_date (#{startTime},'yyyy-mm-dd hh24:mi:ss') and fkdat &lt;= to_date (#{endTime},'yyyy-mm-dd hh24:mi:ss') then fkimg end)fkimg,
        sum(case when fkdat &gt;= to_date (#{startTime},'yyyy-mm-dd hh24:mi:ss') and fkdat &lt;= to_date (#{endTime},'yyyy-mm-dd hh24:mi:ss') and product_grade = 'Ʒ�ָ�' OR product_grade = '�߶˲�Ʒ' OR product_grade = '��ɫս�Բ�Ʒ' then fkimg end)pzgl,
        sum(case when fkdat &gt;= to_date (#{startTime},'yyyy-mm-dd hh24:mi:ss') and fkdat &lt;= to_date (#{endTime},'yyyy-mm-dd hh24:mi:ss') and product_grade = 'Ʒ�ָ�' OR product_grade = '�߶˲�Ʒ' OR product_grade = '��ɫս�Բ�Ʒ' then fkimg end)/
        sum(case when fkdat &gt;= to_date (#{startTime},'yyyy-mm-dd hh24:mi:ss') and fkdat &lt;= to_date (#{endTime},'yyyy-mm-dd hh24:mi:ss')then fkimg end) bz
        from (SELECT
        distinct decode(settle.company_id,
        9580,
        '�Ƹ�',
        9727,
        '����',
        9193,
        '����',
        9196,
        '�и�',
        1932,
        '���',
        8110,
        'ʯ��',
        8493,
        '���',
        7778,
        '����') AS companyname,
        settle.company_id,
        xsztdzb.sale_body,
        rpcl.product_grade,
        settle.fkimg,
        settle.id,
        settle.fkdat,
        sso.order_mount,
        sso.order_type_describe,
        sso.saler_name,
        sso.sale_group,
        (select max(DATA.Name)
        from scm_delivery_detail detail
        JOIN crm_resource_data DATA
        ON DATA.full_name = detail.ext
        AND DATA.company_id = detail.company_id
        AND DATA.TYPE = 3
        AND DATA.parent_name IS NOT NULL
        where settle.company_id = detail.company_id
        and settle.vgbel = detail.deliv_numb
        and settle.vgpos = detail.deliv_item
        and (<![CDATA[ detail.delivery_delete <> 'X' ]]> or
        detail.delivery_delete is null)) name,
        (select max(detail.ext)
        from scm_delivery_detail detail
        where settle.company_id = detail.company_id
        and settle.vgbel = detail.deliv_numb
        and settle.vgpos = detail.deliv_item
        and (<![CDATA[ detail.delivery_delete <> 'X' ]]> or
        detail.delivery_delete is null)) product_line
        FROM scm_steel_settle settle
        left join scm_sale_order sso
        on settle.company_id = sso.company_id
        and settle.aubel = sso.order_no
        and settle.aupos = sso.order_row
        left join (select a.* from price_salebody_relation a where a.is_delete = 0 ) xsztdzb
        ON sso.company_id = xsztdzb.company_id
        AND sso.sale_body = xsztdzb.sale_body_des
        inner join scm_variety_to_pt_gp svtp
        on sso.company_id = svtp.company_id
        and sso.product_code = svtp.product_group

        left join (SELECT a.company_id,
        a.product_class,
        a.product_line_class,
        a.product_class_crude,
        a.product_class_fine,
        a.product_grade
        FROM REPORT_PRODUCT_CLASS_LEVEL a
        where a.status = '0'
        union all
        SELECT b.company_id,
        b.second_code,
        b.product_line_class,
        b.product_class_crude,
        b.product_class_fine,
        b.product_grade
        FROM REPORT_PRODUCT_CLASS_LEVEL b
        where b.status = '0') rpcl
        on sso.company_id = rpcl.company_id
        and sso.product_type = rpcl.product_class
        where
        settle.fkdat &gt;= to_date(#{startTime}, 'yyyy-mm-dd hh24:mi:ss')
        and settle.fkdat &lt;=to_date(#{endTime}, 'yyyy-mm-dd hh24:mi:ss')
        AND(<![CDATA[ xsztdzb.sale_body_des <>'�Ƹ��к�幫˾' ]]> or
        <![CDATA[ xsztdzb.sale_body_des <>'�Ƹֲ���ֹ�˾' ]]>or
        <![CDATA[ xsztdzb.sale_body_des <>'����' ]]> or
        <![CDATA[ xsztdzb.sale_body_des <>'������Ӫ��˾����' ]]>)
        order by settle.id desc) t
        where t.order_type_describe not in
        (select distinct cfd.data_name
        from crm_filter_data cfd
        where cfd.data_type = '2'
        and cfd.status = '0'
        and cfd.company_id = t.company_id)
        and t.saler_name not in
        (select cfd.data_name
        from crm_filter_data cfd
        where cfd.data_type = '1'
        and cfd.status = '0'
        and cfd.company_id = t.company_id
        and instr(concat(t.product_line, t.company_id),
        concat(cfd.product_line, cfd.company_id)) &gt; 0)
        AND t.sale_group NOT IN (SELECT cfd.data_name
        FROM crm_filter_data cfd
        WHERE cfd.company_id = t.company_id
        AND cfd.data_type = 9
        AND cfd.status = 0)
        <if test="zrbm != null">
            and  t.companyname=#{zrbm}
        </if>
        and t.name is not null group by  t.companyname
        ) )c
        left join
        (select
        SAU.ACCOUNTABILITY_UNIT_NAME zrbm,
        JANUARY +
        FEBRUARY +
        MARCH +
        APRIL +
        MAY +
        JUNE +
        JULY +
        AUGUST +
        SEPTEMBER +
        OCTOBER +
        NOVEMBER +
        DECEMBER mbl
        from SCM_ACCOUNTABILITY_UNIT_MANAGE SAU
        LEFT JOIN SCM_TARGET_QUANTITY_MANAGEMENT SQM
        on SAU.ACCOUNTABILITY_UNIT_CODE = SQM.RESPONSIBILITY_UNIT
        where SQM.DELETESTATUS='0') mb
        on mb.zrbm = c.companyName
    </select>


    <select id="getjszl" resultType="map">
        SELECT decode(settle.company_id,
        9580,
        '唐钢',
        9727,
        '邯钢',
        9193,
        '宣钢',
        9196,
        '承钢',
        1932,
        '舞钢',
        8110,
        '石钢',
        8493,
        '衡板',
        7778,
        '邯宝') AS companyname,
        settle.company_id,
        round(SUM(settle.fkimg),2),
        SUM(KZWI6) AS jsjg,
        round(SUM(KZWI6)/SUM(settle.fkimg),2) jsjj
        FROM scm_steel_settle settle
        left JOIN scm_delivery_detail detail
        ON settle.aubel = detail.order_no
        AND settle.aupos = detail.order_item
        JOIN scm_sale_order sso
        ON sso.order_no = settle.aubel
        AND sso.company_id = settle.company_id
        GROUP BY settle.company_id
        ORDER BY company_id
    </select>

    <select id="getpzjszl" resultType="map">
        SELECT
            B.VARIETY,
            round(SUM(settle.fkimg),2) jsl,
            SUM(KZWI6) AS jsjg,
            round(SUM(KZWI6)/SUM(settle.fkimg),2) jsjj
            FROM scm_steel_settle settle
            JOIN scm_sale_order sso
            on sso.order_no = settle.aubel
            and sso.ORDER_ROW = settle.AUPOS
            AND sso.company_id = settle.company_id
            JOIN scm_variety_to_pt_gp B
            ON sso.product_code = B.product_group
            and sso.company_id = B.company_id
            where settle.fkdat   &gt;= to_date(#{startTime},'yyyy-mm-dd hh24:mi:ss')
            AND settle.fkdat   &lt;= to_date(#{endTime},'yyyy-mm-dd hh24:mi:ss')

            group by  B.VARIETY
    </select>

    <select id="getpzgjswc" resultType="map">
        select name ,jsl,pzgl,round(nmb/jsl*100,2) wcl from (
        SELECT
        B.VARIETY name,
        SUM(case when pzg.product_grade = '品种钢'
        OR pzg.product_grade = '高端产品'
        OR pzg.product_grade = '特色战略产品' then fkimg end) pzgl,
        round(SUM(settle.fkimg),2) jsl
        FROM scm_steel_settle settle
        JOIN scm_sale_order sso
        on sso.order_no = settle.aubel
        and sso.ORDER_ROW = settle.AUPOS
        AND sso.company_id = settle.company_id
        JOIN scm_variety_to_pt_gp B
        ON sso.product_code = B.product_group
        and sso.company_id = B.company_id
        JOIN report_product_class_level pzg
        ON sso.company_id = pzg.company_id
        AND sso.product_type = pzg.product_class
        where settle.fkdat &gt;= to_date(#{startTime}, 'yyyy-mm-dd hh24:mi:ss')
        and settle.fkdat &lt;=  to_date(#{endTime}, 'yyyy-mm-dd hh24:mi:ss')
        group by  B.VARIETY ) a
        join (select pz_name,sum(MBL_YEAR) nmb from crm_resource_allocation zyjh where 1=1 group by pz_name) jh
        on jh.pz_name= a.name
   </select>

    <select id="getzgsjswc" resultType="map">
        select companyname name ,sum(fkimg) jsl,rtrim(to_char(round(nmb/jsl*100,2), 'fm9990.99'),'.') || '%' wcl from (
        select* from
        (SELECT decode(settle.company_id,
        9580,
        '唐钢',
        9727,
        '邯钢',
        9193,
        '宣钢',
        9196,
        '承钢',
        1932,
        '舞钢',
        8110,
        '石钢',
        8493,
        '衡板',
        7778,
        '邯宝') AS companyname,
        DATA.NAME,
        settle.company_id,
        sum(settle.fkimg) AS fkimg
        FROM scm_steel_settle settle
        JOIN scm_delivery_detail detail
        on settle.company_id = detail.company_id
        and settle.vgbel = detail.deliv_numb
        and settle.vgpos = detail.deliv_item
        and (detail.delivery_delete != 'X' or
        detail.delivery_delete is null)
        JOIN crm_resource_data DATA
        ON DATA.full_name = detail.ext
        AND DATA.TYPE = 3
        AND DATA.parent_name IS NOT NULL
        where settle.fkdat   &gt;= to_date(#{startTime},'yyyy-mm-dd hh24:mi:ss')
        AND settle.fkdat   &lt;= to_date(#{endTime},'yyyy-mm-dd hh24:mi:ss')
        group by settle.company_id,DATA.NAME
       )a
        left join (select cx_name, sum(MBL_YEAR) mb from crm_resource_allocation group by cx_name) b on b.cx_name=a.NAME ) group by  companyname
</select>

    <select id="getzyjh" resultType="map">
            select *
  from (select '1' yf,year || '1月' rq,PZ_NAME pz,
               cx_name cx,
               fl_name,
               sum(JAN_MONTH) jhl
          from crm_resource_allocation
           where STATUS = '0'
         group by year, PZ_NAME, cx_name, fl_name
        union all
        select '2' yf,year || '2月' rq,PZ_NAME pz,
               cx_name cx,
               fl_name,
               sum(FEB_MONTH) jhl
          from crm_resource_allocation
            where STATUS = '0'
         group by year, PZ_NAME, cx_name, fl_name
        union all
        select '3' yf,year || '3月' rq,PZ_NAME pz,
               cx_name cx,
               fl_name,
               sum(MAR_MONTH) jhl
          from crm_resource_allocation
            where STATUS = '0'
         group by year, PZ_NAME, cx_name, fl_name
        union all
        select '4' yf,year || '4月' rq,PZ_NAME pz,
               cx_name cx,
               fl_name,
               sum(APR_MONTH) jhl
          from crm_resource_allocation
           where STATUS = '0'
         group by year, PZ_NAME, cx_name, fl_name
        union all
        select '5' yf,year || '5月' rq,PZ_NAME pz,
               cx_name cx,
               fl_name,
               sum(MAY_MONTH) jhl
          from crm_resource_allocation
              where STATUS = '0'
         group by year, PZ_NAME, cx_name, fl_name
        union all
        select '6' yf,year || '6月' rq,PZ_NAME pz,
               cx_name cx,
               fl_name,
               sum(JUN_MONTH) jhl
          from crm_resource_allocation
            where STATUS = '0'
         group by year, PZ_NAME, cx_name, fl_name
        union all
        select '7' yf,year || '7月' rq,PZ_NAME pz,
               cx_name cx,
               fl_name,
               sum(JUL_MONTH) jhl
          from crm_resource_allocation
            where STATUS = '0'
         group by year, PZ_NAME, cx_name, fl_name
        union all
        select '8' yf,year || '8月' rq,PZ_NAME pz,
               cx_name cx,
               fl_name,
               sum(AUG_MONTH) jhl
          from crm_resource_allocation
           where STATUS = '0'
         group by year, PZ_NAME, cx_name, fl_name
        union all
        select '9' yf,year || '9月' rq,PZ_NAME pz,
               cx_name cx,
               fl_name,
               sum(SEP_MONTH) jhl
          from crm_resource_allocation
            where STATUS = '0'
         group by year, PZ_NAME, cx_name, fl_name
        union all
        select '10' yf,year || '10月' rq,PZ_NAME pz,
               cx_name cx,
               fl_name,
               sum(OCT_MONTH) jhl
          from crm_resource_allocation
            where STATUS = '0'
         group by year, PZ_NAME, cx_name, fl_name
        union all
        select '11' yf,year || '11月' rq,PZ_NAME pz,
               cx_name cx,
               fl_name,
               sum(NOV_MONTH) jhl
          from crm_resource_allocation
          where STATUS = '0'
         group by year, PZ_NAME, cx_name, fl_name
        union all
        select '12' yf,year || '12月' rq,PZ_NAME pz,
               cx_name cx,
               fl_name,
               sum(DEC_MONTH) jhl
          from crm_resource_allocation
            where STATUS = '0'
         group by year, PZ_NAME, cx_name, fl_name) a

 where
        rq like  '%'||#{nf}||'%'
        <if test="yf != ''">
           and yf = #{yf}
         </if>
        <if test="pz != ''">
           and pz = #{pz}
        </if>
        <if test="cx != ''">
        and cx = #{cx}
        </if>
        <if test="xszt != ''">
        and fl_name = #{xszt}
        </if>
        ORDER BY    fl_name , cx ,
        "DECODE"(pz,'热板','冷板','宽厚板','棒线','型材')
    </select>


    <select id="getzyjhcxtjpz" resultType="map">
        select distinct pz_name pz
        from crm_resource_allocation pz_name
    </select>

    <select id="getzyjhcxtjcx" resultType="map">
        select distinct cx_name cx
        from crm_resource_allocation
        <if test="pz != ''">
            where pz_name = #{pz}
        </if>
    </select>

    <select id="getzyjhcxtjxszt" resultType="map">
        select distinct fl_name xszt
        from crm_resource_allocation pz_name
    </select>

    <select id="getpzhtjd" resultType="map">
        select * from( select VARIETY,zhtl,zjhl,zhtl/zjhl zwcbl from (SELECT
        pz.VARIETY,
        sum(sso.ORDER_MOUNT) zhtl
        from  scm_steel_settle_main zb

        left join
        SCM_SETTLEMENT_DETAILS mx
        on zb.vbeln = mx.VBELN
        LEFT JOIN scm_variety_to_pt_gp pz
        on mx.pz_id = pz.id
        JOIN scm_sale_order sso
        ON sso.order_no = zb.aubel
        AND sso.company_id = zb.company_id
        INNER JOIN scm_variety_to_pt_gp svtpg
        ON sso.product_code = svtpg.product_group
        AND sso.company_id = svtpg.company_id
        AND sso.order_type_describe NOT IN
        (SELECT DISTINCT cfd.data_name
        FROM crm_filter_data cfd
        WHERE cfd.data_type = '2'
        AND cfd.company_id = sso.company_id
        AND cfd.status = '0')
        AND (sso.deleted IS NULL OR sso.deleted != 'X')
        AND sso.sale_group NOT IN
        (SELECT sso.sale_group
        FROM crm_filter_data cfd
        WHERE cfd.company_id = sso.company_id
        AND cfd.data_type = 8
        AND cfd.status = 0)
        AND sso.saler_name NOT IN
        (SELECT t.data_name
        FROM crm_filter_data t
        WHERE t.data_type = '1'
        AND t.status = '0'
        AND t.company_id = sso.company_id)
        LEFT JOIN price_salebody_relation xsztdzb
        ON sso.company_id = xsztdzb.company_id
        AND sso.sale_group = xsztdzb.sale_body_des
        where zb.fkdat   &gt;= to_date(#{startTime},'yyyy-mm-dd hh24:mi:ss')
        AND zb.fkdat   &lt;= to_date(#{endTime},'yyyy-mm-dd hh24:mi:ss')
        <if test="pz != ''">
            and pz.VARIETY =#{pz}
        </if>

        group by pz.VARIETY)a
        join (select pz_name, sum(JAN_MONTH) zjhl from crm_resource_allocation group by pz_name) b on b.pz_name=a.VARIETY)a
        left join (select a.VARIETY,zyhtl,zyjhl,zyhtl/zyjhl zywcbl,htl,zyhtl-zyjhl as zyjd  from (SELECT
        pz.VARIETY,
        sum(sso.ORDER_MOUNT) zyhtl
        from  scm_steel_settle_main zb

        left join
        SCM_SETTLEMENT_DETAILS mx
        on zb.vbeln = mx.VBELN
        LEFT JOIN scm_variety_to_pt_gp pz
        on mx.pz_id = pz.id
        JOIN scm_sale_order sso
        ON sso.order_no = zb.aubel
        AND sso.company_id = zb.company_id
        INNER JOIN scm_variety_to_pt_gp svtpg
        ON sso.product_code = svtpg.product_group
        AND sso.company_id = svtpg.company_id
        AND sso.order_type_describe NOT IN
        (SELECT DISTINCT cfd.data_name
        FROM crm_filter_data cfd
        WHERE cfd.data_type = '2'
        AND cfd.company_id = sso.company_id
        AND cfd.status = '0')
        AND (sso.deleted IS NULL OR sso.deleted != 'X')
        AND sso.sale_group NOT IN
        (SELECT sso.sale_group
        FROM crm_filter_data cfd
        WHERE cfd.company_id = sso.company_id
        AND cfd.data_type = 8
        AND cfd.status = 0)
        AND sso.saler_name NOT IN
        (SELECT t.data_name
        FROM crm_filter_data t
        WHERE t.data_type = '1'
        AND t.status = '0'
        AND t.company_id = sso.company_id)
        LEFT JOIN price_salebody_relation xsztdzb
        ON sso.company_id = xsztdzb.company_id
        AND sso.sale_group = xsztdzb.sale_body_des
        where xsztdzb.sale_body_des='专业公司'
        group by pz.VARIETY )a
        join
        (select pz_name, sum(JAN_MONTH) zyjhl
        from crm_resource_allocation
        where fl_name='销售总公司' group by pz_name) b on b.pz_name=a.VARIETY

        join (SELECT
        pz.VARIETY,
        sum(sso.ORDER_MOUNT) htl
        from  scm_steel_settle_main zb

        left join
        SCM_SETTLEMENT_DETAILS mx
        on zb.vbeln = mx.VBELN
        LEFT JOIN scm_variety_to_pt_gp pz
        on mx.pz_id = pz.id
        JOIN scm_sale_order sso
        ON sso.order_no = zb.aubel
        AND sso.company_id = zb.company_id
        INNER JOIN scm_variety_to_pt_gp svtpg
        ON sso.product_code = svtpg.product_group
        AND sso.company_id = svtpg.company_id
        AND sso.order_type_describe NOT IN
        (SELECT DISTINCT cfd.data_name
        FROM crm_filter_data cfd
        WHERE cfd.data_type = '2'
        AND cfd.company_id = sso.company_id
        AND cfd.status = '0')
        AND (sso.deleted IS NULL OR sso.deleted != 'X')
        AND sso.sale_group NOT IN
        (SELECT sso.sale_group
        FROM crm_filter_data cfd
        WHERE cfd.company_id = sso.company_id
        AND cfd.data_type = 8
        AND cfd.status = 0)
        AND sso.saler_name NOT IN
        (SELECT t.data_name
        FROM crm_filter_data t
        WHERE t.data_type = '1'
        AND t.status = '0'
        AND t.company_id = sso.company_id)
        LEFT JOIN price_salebody_relation xsztdzb
        ON sso.company_id = xsztdzb.company_id
        AND sso.sale_group = xsztdzb.sale_body_des
        where xsztdzb.sale_body_des='分公司'
        group by pz.VARIETY )c on a.VARIETY=c.VARIETY) b on a.VARIETY = b.VARIETY


        left join (select a.VARIETY,zgshtl,zgsjhl,zgshtl/zgsjhl zgswcbl,zgshtl- zgsjhl as zgsjd from (SELECT
        pz.VARIETY,
        sum(sso.ORDER_MOUNT) zgshtl
        from  scm_steel_settle_main zb

        left join
        SCM_SETTLEMENT_DETAILS mx
        on zb.vbeln = mx.VBELN
        LEFT JOIN scm_variety_to_pt_gp pz
        on mx.pz_id = pz.id
        JOIN scm_sale_order sso
        ON sso.order_no = zb.aubel
        AND sso.company_id = zb.company_id
        INNER JOIN scm_variety_to_pt_gp svtpg
        ON sso.product_code = svtpg.product_group
        AND sso.company_id = svtpg.company_id
        AND sso.order_type_describe NOT IN
        (SELECT DISTINCT cfd.data_name
        FROM crm_filter_data cfd
        WHERE cfd.data_type = '2'
        AND cfd.company_id = sso.company_id
        AND cfd.status = '0')
        AND (sso.deleted IS NULL OR sso.deleted != 'X')
        AND sso.sale_group NOT IN
        (SELECT sso.sale_group
        FROM crm_filter_data cfd
        WHERE cfd.company_id = sso.company_id
        AND cfd.data_type = 8
        AND cfd.status = 0)
        AND sso.saler_name NOT IN
        (SELECT t.data_name
        FROM crm_filter_data t
        WHERE t.data_type = '1'
        AND t.status = '0'
        AND t.company_id = sso.company_id)
        LEFT JOIN price_salebody_relation xsztdzb
        ON sso.company_id = xsztdzb.company_id
        AND sso.sale_group = xsztdzb.sale_body_des
        where xsztdzb.sale_body_des='子公司'
        or xsztdzb.sale_body_des='技术公司'
        or xsztdzb.sale_body_des='事业部'
        group by pz.VARIETY )a
        join
        (select pz_name, sum(JAN_MONTH) zgsjhl
        from crm_resource_allocation
        where fl_name='子公司' or fl_name='技术公司' or fl_name ='事业部' group by pz_name) b
        on b.pz_name=a.VARIETY) c on a.VARIETY=c.VARIETY
        left join ( select a.VARIETY,ckhtl,ckjhl,ckhtl/ckjhl ckwcb,ckhtl- ckjhl as ckjd from (SELECT
        pz.VARIETY,
        sum(sso.ORDER_MOUNT) ckhtl
        from  scm_steel_settle_main zb

        left join
        SCM_SETTLEMENT_DETAILS mx
        on zb.vbeln = mx.VBELN
        LEFT JOIN scm_variety_to_pt_gp pz
        on mx.pz_id = pz.id
        JOIN scm_sale_order sso
        ON sso.order_no = zb.aubel
        AND sso.company_id = zb.company_id
        INNER JOIN scm_variety_to_pt_gp svtpg
        ON sso.product_code = svtpg.product_group
        AND sso.company_id = svtpg.company_id
        AND sso.order_type_describe NOT IN
        (SELECT DISTINCT cfd.data_name
        FROM crm_filter_data cfd
        WHERE cfd.data_type = '2'
        AND cfd.company_id = sso.company_id
        AND cfd.status = '0')
        AND (sso.deleted IS NULL OR sso.deleted != 'X')
        AND sso.sale_group NOT IN
        (SELECT sso.sale_group
        FROM crm_filter_data cfd
        WHERE cfd.company_id = sso.company_id
        AND cfd.data_type = 8
        AND cfd.status = 0)
        AND sso.saler_name NOT IN
        (SELECT t.data_name
        FROM crm_filter_data t
        WHERE t.data_type = '1'
        AND t.status = '0'
        AND t.company_id = sso.company_id)
        LEFT JOIN price_salebody_relation xsztdzb
        ON sso.company_id = xsztdzb.company_id
        AND sso.sale_group = xsztdzb.sale_body_des
        where xsztdzb.sale_body_des='出口'
        group by pz.VARIETY )a
        join
        (select pz_name, sum(JAN_MONTH) ckjhl
        from crm_resource_allocation
        where fl_name='出口' group by pz_name) b
        on b.pz_name=a.VARIETY) d on a.VARIETY=d.VARIETY
    </select>

    <select id="getcxhtjd" resultType="map">
   select * from(select name,zhtl,zjhl,zhtl/zjhl zwcbl from (SELECT
        DATA.NAME,
        sum(sso.ORDER_MOUNT) zhtl
        FROM scm_steel_settle settle
        JOIN scm_delivery_detail detail
        ON settle.aubel = detail.order_no
        AND settle.aupos = detail.order_item
        JOIN crm_resource_data DATA
        ON DATA.full_name = detail.ext
        AND DATA.TYPE = 3
        AND DATA.parent_name IS NOT NULL
        JOIN scm_sale_order sso
        ON sso.order_no = settle.aubel
        AND sso.company_id = settle.company_id
        INNER JOIN scm_variety_to_pt_gp svtpg
        ON sso.product_code = svtpg.product_group
        AND sso.company_id = svtpg.company_id
        AND sso.order_type_describe NOT IN
        (SELECT DISTINCT cfd.data_name
        FROM crm_filter_data cfd
        WHERE cfd.data_type = '2'
        AND cfd.company_id = sso.company_id
        AND cfd.status = '0')
        AND (sso.deleted IS NULL OR sso.deleted != 'X')
        AND sso.sale_group NOT IN
        (SELECT sso.sale_group
        FROM crm_filter_data cfd
        WHERE cfd.company_id = sso.company_id
        AND cfd.data_type = 8
        AND cfd.status = 0)
        AND sso.saler_name NOT IN
        (SELECT t.data_name
        FROM crm_filter_data t
        WHERE t.data_type = '1'
        AND t.status = '0'
        AND t.company_id = sso.company_id)
        LEFT JOIN price_salebody_relation xsztdzb
        ON sso.company_id = xsztdzb.company_id
        AND sso.sale_group = xsztdzb.sale_body_des
        where settle.fkdat   &gt;= to_date(#{startTime},'yyyy-mm-dd hh24:mi:ss')
        AND settle.fkdat   &lt;= to_date(#{endTime},'yyyy-mm-dd hh24:mi:ss')
        <if test="cx != ''">
        and DATA.NAME =#{cx}
        </if>
        group by DATA.NAME )a
        join (select cx_name, sum(JAN_MONTH) zjhl from crm_resource_allocation group by cx_name) b on b.cx_name=a.NAME)a
        left join (select a.name,zyhtl,zyjhl,zyhtl/zyjhl wcbl,zyhtl- zyjhl as jd,htl from
       (SELECT
        DATA.name,
        sum(sso.ORDER_MOUNT) zyhtl
       FROM scm_steel_settle settle
        JOIN scm_delivery_detail detail
        ON settle.aubel = detail.order_no
        AND settle.aupos = detail.order_item
        JOIN crm_resource_data DATA
        ON DATA.full_name = detail.ext
        AND DATA.TYPE = 3
        AND DATA.parent_name IS NOT NULL
        JOIN scm_sale_order sso
        ON sso.order_no = settle.aubel
        AND sso.company_id = settle.company_id
        INNER JOIN scm_variety_to_pt_gp svtpg
        ON sso.product_code = svtpg.product_group
        AND sso.company_id = svtpg.company_id
        AND sso.order_type_describe NOT IN
        (SELECT DISTINCT cfd.data_name
        FROM crm_filter_data cfd
        WHERE cfd.data_type = '2'
        AND cfd.company_id = sso.company_id
        AND cfd.status = '0')
        AND (sso.deleted IS NULL OR sso.deleted != 'X')
        AND sso.sale_group NOT IN
        (SELECT sso.sale_group
        FROM crm_filter_data cfd
        WHERE cfd.company_id = sso.company_id
        AND cfd.data_type = 8
        AND cfd.status = 0)
        AND sso.saler_name NOT IN
        (SELECT t.data_name
        FROM crm_filter_data t
        WHERE t.data_type = '1'
        AND t.status = '0'
        AND t.company_id = sso.company_id)
        LEFT JOIN price_salebody_relation xsztdzb
        ON sso.company_id = xsztdzb.company_id
        AND sso.sale_group = xsztdzb.sale_body_des
        where xsztdzb.sale_body_des='专业公司'
        group by DATA.name )a
        join
        (select cx_name, sum(JAN_MONTH) zyjhl
        from crm_resource_allocation
        where fl_name='销售总公司' group by cx_name) b
        on b.cx_name=a.name
        join (SELECT
        DATA.name,
        sum(sso.ORDER_MOUNT) htl
       FROM scm_steel_settle settle
        JOIN scm_delivery_detail detail
        ON settle.aubel = detail.order_no
        AND settle.aupos = detail.order_item
        JOIN crm_resource_data DATA
        ON DATA.full_name = detail.ext
        AND DATA.TYPE = 3
        AND DATA.parent_name IS NOT NULL
        JOIN scm_sale_order sso
        ON sso.order_no = settle.aubel
        AND sso.company_id = settle.company_id
        INNER JOIN scm_variety_to_pt_gp svtpg
        ON sso.product_code = svtpg.product_group
        AND sso.company_id = svtpg.company_id
        AND sso.order_type_describe NOT IN
        (SELECT DISTINCT cfd.data_name
        FROM crm_filter_data cfd
        WHERE cfd.data_type = '2'
        AND cfd.company_id = sso.company_id
        AND cfd.status = '0')
        AND (sso.deleted IS NULL OR sso.deleted != 'X')
        AND sso.sale_group NOT IN
        (SELECT sso.sale_group
        FROM crm_filter_data cfd
        WHERE cfd.company_id = sso.company_id
        AND cfd.data_type = 8
        AND cfd.status = 0)
        AND sso.saler_name NOT IN
        (SELECT t.data_name
        FROM crm_filter_data t
        WHERE t.data_type = '1'
        AND t.status = '0'
        AND t.company_id = sso.company_id)
        LEFT JOIN price_salebody_relation xsztdzb
        ON sso.company_id = xsztdzb.company_id
        AND sso.sale_group = xsztdzb.sale_body_des
        where xsztdzb.sale_body_des='分公司'
        group by DATA.name) c   on a.name=c.name) b on a.name = b.name
        left join (select a.name,zgshtl,zgsjhl,zgshtl/zgsjhl zgswcbl,zgshtl- zgsjhl as zgsjd from
        (SELECT
        DATA.name,
        sum(sso.ORDER_MOUNT) zgshtl
        FROM scm_steel_settle settle
        JOIN scm_delivery_detail detail
        ON settle.aubel = detail.order_no
        AND settle.aupos = detail.order_item
        JOIN crm_resource_data DATA
        ON DATA.full_name = detail.ext
        AND DATA.TYPE = 3
        AND DATA.parent_name IS NOT NULL
        JOIN scm_sale_order sso
        ON sso.order_no = settle.aubel
        AND sso.company_id = settle.company_id
        INNER JOIN scm_variety_to_pt_gp svtpg
        ON sso.product_code = svtpg.product_group
        AND sso.company_id = svtpg.company_id
        AND sso.order_type_describe NOT IN
        (SELECT DISTINCT cfd.data_name
        FROM crm_filter_data cfd
        WHERE cfd.data_type = '2'
        AND cfd.company_id = sso.company_id
        AND cfd.status = '0')
        AND (sso.deleted IS NULL OR sso.deleted != 'X')
        AND sso.sale_group NOT IN
        (SELECT sso.sale_group
        FROM crm_filter_data cfd
        WHERE cfd.company_id = sso.company_id
        AND cfd.data_type = 8
        AND cfd.status = 0)
        AND sso.saler_name NOT IN
        (SELECT t.data_name
        FROM crm_filter_data t
        WHERE t.data_type = '1'
        AND t.status = '0'
        AND t.company_id = sso.company_id)
        LEFT JOIN price_salebody_relation xsztdzb
        ON sso.company_id = xsztdzb.company_id
        AND sso.sale_group = xsztdzb.sale_body_des
        where xsztdzb.sale_body_des='子公司'
        or xsztdzb.sale_body_des='技术公司'
        or xsztdzb.sale_body_des='事业部'
        group by DATA.name )a
        join
        (select cx_name, sum(JAN_MONTH) zgsjhl
        from crm_resource_allocation
        where  fl_name='子公司' or fl_name='技术公司' or fl_name ='事业部' group by cx_name) b
        on b.cx_name=a.name) c on a.name=c.name
        left join (select a.name,ckhtl,ckjhl,ckhtl/ckjhl ckwcbl,ckhtl- ckjhl as ckjd from
        (SELECT
        DATA.name,
        sum(sso.ORDER_MOUNT) ckhtl
        FROM scm_steel_settle settle
        JOIN scm_delivery_detail detail
        ON settle.aubel = detail.order_no
        AND settle.aupos = detail.order_item
        JOIN crm_resource_data DATA
        ON DATA.full_name = detail.ext
        AND DATA.TYPE = 3
        AND DATA.parent_name IS NOT NULL
        JOIN scm_sale_order sso
        ON sso.order_no = settle.aubel
        AND sso.company_id = settle.company_id
        INNER JOIN scm_variety_to_pt_gp svtpg
        ON sso.product_code = svtpg.product_group
        AND sso.company_id = svtpg.company_id
        AND sso.order_type_describe NOT IN
        (SELECT DISTINCT cfd.data_name
        FROM crm_filter_data cfd
        WHERE cfd.data_type = '2'
        AND cfd.company_id = sso.company_id
        AND cfd.status = '0')
        AND (sso.deleted IS NULL OR sso.deleted != 'X')
        AND sso.sale_group NOT IN
        (SELECT sso.sale_group
        FROM crm_filter_data cfd
        WHERE cfd.company_id = sso.company_id
        AND cfd.data_type = 8
        AND cfd.status = 0)
        AND sso.saler_name NOT IN
        (SELECT t.data_name
        FROM crm_filter_data t
        WHERE t.data_type = '1'
        AND t.status = '0'
        AND t.company_id = sso.company_id)
        LEFT JOIN price_salebody_relation xsztdzb
        ON sso.company_id = xsztdzb.company_id
        AND sso.sale_group = xsztdzb.sale_body_des
        where xsztdzb.sale_body_des='出口'
        group by DATA.name )a
        join
        (select cx_name, sum(JAN_MONTH) ckjhl
        from crm_resource_allocation
        where  fl_name='出口'  group by cx_name) b
        on b.cx_name=a.name) d on a.name=d.name
    </select>



</mapper>
